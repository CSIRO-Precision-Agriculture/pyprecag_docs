

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyprecag.processing &mdash; pyprecag 0.3.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> pyprecag
          

          
          </a>

          
            
            
              <div class="version">
                0.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyprecag</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pyprecag.processing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyprecag.processing</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">izip</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">tempfile</span> <span class="k">import</span> <span class="n">NamedTemporaryFile</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">rasterio</span>

<span class="kn">from</span> <span class="nn">fiona.crs</span> <span class="k">import</span> <span class="n">from_epsg</span>
<span class="kn">from</span> <span class="nn">geopandas</span> <span class="k">import</span> <span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">GeoSeries</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="k">import</span> <span class="n">gdal</span>

<span class="kn">from</span> <span class="nn">rasterio</span> <span class="k">import</span> <span class="n">features</span>
<span class="kn">from</span> <span class="nn">rasterio.io</span> <span class="k">import</span> <span class="n">MemoryFile</span>
<span class="kn">from</span> <span class="nn">rasterio.fill</span> <span class="k">import</span> <span class="n">fillnodata</span>
<span class="kn">from</span> <span class="nn">rasterio.mask</span> <span class="k">import</span> <span class="n">mask</span> <span class="k">as</span> <span class="n">rio_mask</span>
<span class="kn">from</span> <span class="nn">rasterio.warp</span> <span class="k">import</span> <span class="n">reproject</span><span class="p">,</span> <span class="n">Resampling</span>
<span class="c1"># from rasterio.warp import aligned_target</span>
<span class="kn">from</span> <span class="nn">rasterio.windows</span> <span class="k">import</span> <span class="n">get_data_window</span><span class="p">,</span> <span class="n">intersection</span><span class="p">,</span> <span class="n">from_bounds</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.vq</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>

<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="k">import</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span> <span class="n">mapping</span>
<span class="kn">from</span> <span class="nn">shapely.ops</span> <span class="k">import</span> <span class="n">linemerge</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">crs</span> <span class="k">as</span> <span class="n">pyprecag_crs</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">config</span>

<span class="kn">from</span> <span class="nn">.table_ops</span> <span class="k">import</span> <span class="n">calculate_strip_stats</span>
<span class="kn">from</span> <span class="nn">.convert</span> <span class="k">import</span> <span class="n">convert_polygon_to_grid</span><span class="p">,</span> <span class="n">convert_grid_to_vesper</span><span class="p">,</span> <span class="n">numeric_pixelsize_to_string</span><span class="p">,</span> \
    <span class="n">convert_polygon_feature_to_raster</span><span class="p">,</span> <span class="n">drop_z</span><span class="p">,</span> <span class="n">deg_to_8_compass_pts</span><span class="p">,</span> <span class="n">point_to_point_bearing</span><span class="p">,</span> \
    <span class="n">text_rotation</span>

<span class="kn">from</span> <span class="nn">.describe</span> <span class="k">import</span> <span class="n">save_geopandas_tofile</span><span class="p">,</span> <span class="n">VectorDescribe</span><span class="p">,</span> <span class="n">get_dataframe_encoding</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="k">import</span> <span class="n">GeometryError</span><span class="p">,</span> <span class="n">SpatialReferenceError</span>
<span class="kn">from</span> <span class="nn">.vector_ops</span> <span class="k">import</span> <span class="n">thin_point_by_distance</span>
<span class="kn">from</span> <span class="nn">.raster_ops</span> <span class="k">import</span> <span class="n">focal_statistics</span><span class="p">,</span> <span class="n">save_in_memory_raster_to_file</span><span class="p">,</span> <span class="n">reproject_image</span><span class="p">,</span> \
    <span class="n">calculate_image_indices</span><span class="p">,</span> <span class="n">stack_and_clip_rasters</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>


<div class="viewcode-block" id="block_grid"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.block_grid">[docs]</a><span class="k">def</span> <span class="nf">block_grid</span><span class="p">(</span><span class="n">in_shapefilename</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">out_rasterfilename</span><span class="p">,</span>
               <span class="n">out_vesperfilename</span><span class="p">,</span> <span class="n">nodata_val</span><span class="o">=-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a polygon boundary to a 0,1 raster and generate a VESPER compatible list of</span>
<span class="sd">       coordinates for kriging.</span>

<span class="sd">        Args:</span>

<span class="sd">            in_shapefilename (str): Input polygon shapefile</span>
<span class="sd">            pixel_size (float):  The required output pixel size</span>
<span class="sd">            out_rasterfilename (str): Filename of the raster Tiff that will be created</span>
<span class="sd">            out_vesperfilename (str):  The output vesper file</span>
<span class="sd">            nodata_val (int): an integer to use as nodata</span>
<span class="sd">            snap (bool): Snap Extent to a factor of the Pixel size</span>
<span class="sd">            overwrite (bool): if true overwrite existing file</span>

<span class="sd">        Requirements: Input shapefile should be in a projected coordinate system........</span>

<span class="sd">        Notes:</span>
<span class="sd">            Define pixel_size and no data value of new raster</span>
<span class="sd">            see http://stackoverflow.com/questions/2220749/rasterizing-a-gdal-layer</span>
<span class="sd">                https://gis.stackexchange.com/a/31658</span>

<span class="sd">            This works, but the extent of the output differs from that of an arcpy generated raster.</span>
<span class="sd">            See post: https://gis.stackexchange.com/q/139336</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Pixel size must be an integer or floating number.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodata_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Nodata value must be an integer.&#39;</span><span class="p">)</span>

    <span class="n">desc_poly_shp</span> <span class="o">=</span> <span class="n">VectorDescribe</span><span class="p">(</span><span class="n">in_shapefilename</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">desc_poly_shp</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">srs</span><span class="o">.</span><span class="n">IsProjected</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">SpatialReferenceError</span><span class="p">(</span><span class="s1">&#39;Shapefile must be in a projected coordinate system&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;POLY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc_poly_shp</span><span class="o">.</span><span class="n">geometry_type</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">GeometryError</span><span class="p">(</span><span class="s1">&#39;Invalid Geometry. Input shapefile should be polygon or multipolygon&#39;</span><span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">convert_polygon_to_grid</span><span class="p">(</span><span class="n">in_shapefilename</span><span class="o">=</span><span class="n">in_shapefilename</span><span class="p">,</span>
                            <span class="n">out_rasterfilename</span><span class="o">=</span><span class="n">out_rasterfilename</span><span class="p">,</span>
                            <span class="n">pixel_size</span><span class="o">=</span><span class="n">pixel_size</span><span class="p">,</span>
                            <span class="n">snap_extent_to_pixel</span><span class="o">=</span><span class="n">snap</span><span class="p">,</span>
                            <span class="n">nodata_val</span><span class="o">=</span><span class="n">nodata_val</span><span class="p">,</span>
                            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

    <span class="n">convert_grid_to_vesper</span><span class="p">(</span><span class="n">in_rasterfilename</span><span class="o">=</span><span class="n">out_rasterfilename</span><span class="p">,</span>
                           <span class="n">out_vesperfilename</span><span class="o">=</span><span class="n">out_vesperfilename</span><span class="p">)</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="se">\t</span><span class="si">{dur:&lt;15}</span><span class="se">\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                               <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span></div>


<div class="viewcode-block" id="create_polygon_from_point_trail"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.create_polygon_from_point_trail">[docs]</a><span class="k">def</span> <span class="nf">create_polygon_from_point_trail</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">points_crs</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">,</span> <span class="n">thin_dist_m</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                    <span class="n">aggregate_dist_m</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">buffer_dist_m</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shrink_dist_m</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a polygon from a Point Trail created from a file containing GPS coordinates.</span>

<span class="sd">    The point order should be sorted by increasing time sequence to ensure the &#39;dot-to-dot&#39; occurs</span>
<span class="sd">    correctly.</span>

<span class="sd">    The workflow is as follows:</span>
<span class="sd">          Points -&gt; Lines -&gt; Buffer Out (expand) -&gt; Buffer In (shrink)</span>

<span class="sd">    For efficiency, points will be thinned. This will remove points less than the set thinDist.</span>
<span class="sd">    Resulting points will be connected to form lines.</span>

<span class="sd">    Line ends are detected where the distance between points is greater than the aggregate distance.</span>
<span class="sd">     This will occur at a turning point or interruption (ie creek) and gps point collection is</span>
<span class="sd">    stopped. Typically this distance is slightly greater than the row/swath width.</span>

<span class="sd">    Buffering is used to convert to polygon and remove the gap between row_count/swaths. The buffer</span>
<span class="sd">    distance is usually half the row/swath width.</span>

<span class="sd">    Buffering with a negative value is used to remove excess area on the outside of the polygon.</span>
<span class="sd">    This shrink distance is usually around 7m less than the buffer distance.</span>

<span class="sd">    Args:</span>
<span class="sd">        points_geodataframe (geopandas.geodataframe.GeoDataFrame): Input points vector geodataframe</span>
<span class="sd">        points_crs (pyprecag_crs.crs): The Projected Spatial Reference System of the</span>
<span class="sd">                    point_geodataframe</span>
<span class="sd">        out_filename (str): Output polygon file. This should be the same format as the input.</span>
<span class="sd">        thin_dist_m (float): The minimum distance in metres between points to be used to thin the</span>
<span class="sd">                    points dataset.</span>
<span class="sd">        aggregate_dist_m (int): A floating number representing the maximum distance between point.</span>
<span class="sd">                    This is used to detect a line end. Typically this is slightly larger than</span>
<span class="sd">                    the row/swath width.</span>
<span class="sd">        buffer_dist_m (int): The Buffer distance in metres. Typically half the swath or row width.</span>
<span class="sd">        shrink_dist_m (int): The shrink distance in metres. Typically about 7 less than the buffer</span>
<span class="sd">                    distance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">argCheck</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;thin_dist_m&#39;</span><span class="p">,</span> <span class="n">thin_dist_m</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;aggregate_dist_m&#39;</span><span class="p">,</span> <span class="n">aggregate_dist_m</span><span class="p">),</span>
                     <span class="p">(</span><span class="s1">&#39;buffer_dist_m&#39;</span><span class="p">,</span> <span class="n">buffer_dist_m</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;shrink_dist_m&#39;</span><span class="p">,</span> <span class="n">shrink_dist_m</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argCheck</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> must be a floating number.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argCheck</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : inputGeoDataFrame&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;POINT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="o">.</span><span class="n">geom_type</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : A points geopandas dataframe is required&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points_crs</span><span class="p">,</span> <span class="n">pyprecag_crs</span><span class="o">.</span><span class="n">crs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Crs must be an instance of pyprecag.crs.crs&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out_filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">out_filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please specify an output filename&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Output directory </span><span class="si">{}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)))</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">points_geodataframe</span> <span class="o">=</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;FID&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">points_geodataframe</span><span class="p">[</span><span class="s1">&#39;FID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># don&#39;t need any attribution so drop it all except fid and geometry</span>
    <span class="n">dropcols</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">ea</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;FID&#39;</span><span class="p">]]</span>
    <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dropcols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ptsgdf_crs</span> <span class="o">=</span> <span class="n">points_crs</span><span class="o">.</span><span class="n">epsg</span>

    <span class="n">gdf_thin</span> <span class="o">=</span> <span class="n">thin_point_by_distance</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">points_crs</span><span class="p">,</span> <span class="n">thin_dist_m</span><span class="p">)</span>
    <span class="n">gdf_thin</span> <span class="o">=</span> <span class="n">gdf_thin</span><span class="p">[</span><span class="n">gdf_thin</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">del</span> <span class="n">points_geodataframe</span>

    <span class="n">dropcols</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">gdf_thin</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">ea</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;FID&#39;</span><span class="p">]]</span>
    <span class="n">gdf_thin</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dropcols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># calc distance between two points</span>
    <span class="n">gdf_thin</span><span class="p">[</span><span class="s1">&#39;dist_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_thin</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">gdf_thin</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Calc first value to be 0</span>
    <span class="n">gdf_thin</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdf_thin</span><span class="p">[</span><span class="s1">&#39;dist_shift&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="s1">&#39;dist_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># apply a new row/line id when distance between points is greater than 25m</span>
    <span class="n">gdf_thin</span><span class="p">[</span><span class="s2">&quot;lineID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_thin</span><span class="p">[</span><span class="s2">&quot;dist_shift&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">aggregate_dist_m</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Assign lineID&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                             <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

    <span class="n">temp_file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="n">temp_file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
            <span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="s1">&#39;_0thnpts.shp&#39;</span><span class="p">)))]</span>

        <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_thin</span><span class="p">,</span> <span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># A line must have at least two points so remove lines with only one point.</span>
    <span class="c1"># count all points per lineID</span>
    <span class="n">ptsperline</span> <span class="o">=</span> <span class="n">gdf_thin</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;lineID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="c1"># select all LineID&#39;s with more than one point</span>
    <span class="n">gdf_thin</span> <span class="o">=</span> <span class="n">gdf_thin</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdf_thin</span><span class="p">[</span><span class="s1">&#39;lineID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ptsperline</span><span class="p">[</span><span class="n">ptsperline</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

    <span class="c1"># convert to lines</span>
    <span class="c1"># source https://gis.stackexchange.com/a/202274</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Aggregate these points with the GroupBy - for shapely 1.3.2+ use</span>
        <span class="n">df_line</span> <span class="o">=</span> <span class="n">gdf_thin</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;lineID&#39;</span><span class="p">])[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">LineString</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">df_line</span> <span class="o">=</span> <span class="n">gdf_thin</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;lineID&#39;</span><span class="p">])[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">LineString</span><span class="p">([(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]))</span>

    <span class="n">gdf_final</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">df_line</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">gdf_thin</span><span class="p">,</span> <span class="n">ptsperline</span><span class="p">,</span> <span class="n">df_line</span>
    <span class="n">gdf_final</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">ptsgdf_crs</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Convert to lines&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                             <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="n">temp_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
            <span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="s1">&#39;_1line.shp&#39;</span><span class="p">))))</span>

        <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_final</span><span class="p">,</span> <span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># buffer and dissolve overlap of lines</span>
    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">gdf_final</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">gdf_final</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_dist_m</span><span class="p">)</span><span class="o">.</span><span class="n">unary_union</span><span class="p">])</span>
    <span class="n">gdf_final</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">ptsgdf_crs</span>
    <span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;FID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_final</span><span class="o">.</span><span class="n">index</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Buffer by </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">buffer_dist_m</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                             <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="n">temp_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="s1">&#39;_2buf.shp&#39;</span><span class="p">))))</span>

        <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_final</span><span class="p">,</span> <span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shrink_dist_m</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">gdf_final</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">gdf_final</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">shrink_dist_m</span><span class="p">)))</span>
        <span class="n">gdf_final</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">ptsgdf_crs</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Shrink by </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shrink_dist_m</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                 <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
            <span class="n">temp_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">out_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="s1">&#39;_3bufshrink.shp&#39;</span><span class="p">))))</span>
            <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_final</span><span class="p">,</span> <span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># https://github.com/geopandas/geopandas/issues/174#issuecomment-63126908</span>
    <span class="n">explode</span> <span class="o">=</span> <span class="n">gdf_final</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;geometry&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">)[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>

    <span class="n">gdf_final</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">explode</span><span class="p">)</span>
    <span class="n">gdf_final</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">ptsgdf_crs</span>
    <span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;FID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_final</span><span class="o">.</span><span class="n">index</span>
    <span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;Area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_final</span><span class="o">.</span><span class="n">area</span>
    <span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;Perimeter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_final</span><span class="o">.</span><span class="n">length</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Explode polygons&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                             <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

    <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_final</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="se">\t</span><span class="si">{dur:&lt;15}</span><span class="se">\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                               <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span>

    <span class="n">thin_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mf">3.14</span> <span class="o">*</span> <span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;Area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span>
                  <span class="p">(</span><span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;Perimeter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;Perimeter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;25}</span><span class="s1"> </span><span class="si">{:.5f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Thin Ratio : &#39;</span><span class="p">,</span> <span class="n">thin_ratio</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">thin_ratio</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;For an improved result, increase the buffer width and shrink &#39;</span>
                       <span class="s1">&#39;distance and try again.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;For an improved result, increase the buffer width and shrink distance and &#39;</span> \
               <span class="s1">&#39;try again.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="clean_trim_points"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.clean_trim_points">[docs]</a><span class="k">def</span> <span class="nf">clean_trim_points</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">points_crs</span><span class="p">,</span> <span class="n">process_column</span><span class="p">,</span> <span class="n">output_csvfile</span><span class="p">,</span>
                      <span class="n">boundary_polyfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_keep_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_removed_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">remove_zeros</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdevs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">iterative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_dist_m</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Clean and/or Trim a points dataframe.</span>

<span class="sd">        Preparation includes:</span>
<span class="sd">            - Clip data to polygon.</span>
<span class="sd">            - Move data to a Projected Coordinate system.</span>
<span class="sd">            - Remove values where data_column are less than or equal to zero</span>
<span class="sd">            - Calculate Normalised value for data_column (number of StDev).</span>
<span class="sd">            - Iteratively Trim outliers based on Normalised data_column</span>
<span class="sd">            - Remove points closer than a set distance (trim_dist_m)</span>

<span class="sd">    Args:</span>
<span class="sd">        points_geodataframe (geopandas.geodataframe.GeoDataFrame): The input points geodataframe</span>
<span class="sd">        points_crs (pyprecag_crs.crs): The Spatial Reference System of the point_geodataframe</span>
<span class="sd">        process_column (str):  The column  to normalise, trim and clean.</span>
<span class="sd">        output_csvfile (str): The Trimmed &amp; Cleaned output CSV file</span>
<span class="sd">        out_keep_shapefile (str): Optionally save the Trimmed &amp; Cleaned to a shapefile</span>
<span class="sd">        out_removed_shapefile (str): Optionally save a shapefile containing features removed while</span>
<span class="sd">                    cleaning/filtering. A column called filter will be added showing the reason a</span>
<span class="sd">                    point was removed.</span>
<span class="sd">        boundary_polyfile (str): Optionally a polygon used to Clip the points.</span>
<span class="sd">        remove_zeros (bool): Optionally remove values where data_column are &lt;= to zero</span>
<span class="sd">                    prior to removing outliers.</span>
<span class="sd">        stdevs (int): The number of standard deviations used to trim outliers</span>
<span class="sd">        iterative (bool): Optionally Iteratively Trim outliers based on Normalised Data column</span>
<span class="sd">        thin_dist_m (float): A distance in metres representing the minimum allowed distance</span>
<span class="sd">                    between points. Points less than this distance will be removed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.geodataframe.GeoDataFrame: Representing the cleaned/trimmed data file.</span>
<span class="sd">                   New columns included in the output are:</span>
<span class="sd">                      Eastings, Northings  - The point coordinates in a projected coordinate system</span>
<span class="sd">                      EN_Epsg  - The epsg number of the projected coordinate system</span>
<span class="sd">                      Nrm_    - normalise data_column calculation.</span>
<span class="sd">        pyprecag_crs.crs: The pyprecag CRS object of the points dataframe.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : inputGeodataFrame&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;POINT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="o">.</span><span class="n">geom_type</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : a points geopandas dataframe is required&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points_crs</span><span class="p">,</span> <span class="n">pyprecag_crs</span><span class="o">.</span><span class="n">crs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Crs must be an instance of pyprecag.crs.crs&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_csvfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : an output csv path and file is required&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">argCheck</span> <span class="ow">in</span> <span class="p">[</span><span class="n">output_csvfile</span><span class="p">,</span> <span class="n">out_keep_shapefile</span><span class="p">,</span> <span class="n">out_removed_shapefile</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">argCheck</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">argCheck</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Output folder does not exist: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">argCheck</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">argCheck</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;thinDist_m&#39;</span><span class="p">,</span> <span class="n">thin_dist_m</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;stdev&#39;</span><span class="p">,</span> <span class="n">stdevs</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argCheck</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> must be a integer or floating number.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argCheck</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">process_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Column </span><span class="si">{}</span><span class="s1"> does not exist in input geodataframe&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process_column</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">argCheck</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;remove_zeros&#39;</span><span class="p">,</span> <span class="n">remove_zeros</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;iterative&#39;</span><span class="p">,</span> <span class="n">iterative</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argCheck</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> should be a boolean.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argCheck</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">norm_column</span> <span class="o">=</span> <span class="s1">&#39;nrm_&#39;</span> <span class="o">+</span> <span class="n">process_column</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Normalized Column is </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">norm_column</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">norm_column</span> <span class="ow">in</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Column </span><span class="si">{}</span><span class="s1"> already exists and will be overwritten&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">norm_column</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">boundary_polyfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">boundary_polyfile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Invalid path: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">boundary_polyfile</span><span class="p">))</span>

        <span class="n">ply_desc</span> <span class="o">=</span> <span class="n">VectorDescribe</span><span class="p">(</span><span class="n">boundary_polyfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;POLY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ply_desc</span><span class="o">.</span><span class="n">geometry_type</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">GeometryError</span><span class="p">(</span><span class="s1">&#39;Invalid geometry. Input shapefile should be polygon&#39;</span>
                                <span class="s1">&#39; or multipolygon&#39;</span><span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># set a UniqueID Field which ISNT the FID for use through out the processing</span>
    <span class="n">id_col</span> <span class="o">=</span> <span class="s1">&#39;PT_UID&#39;</span>  <span class="c1"># IE clean/trim fid</span>
    <span class="n">points_geodataframe</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">index</span>
    <span class="n">gdf_points</span> <span class="o">=</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># To speed things up, drop all unrequired columns</span>
    <span class="n">dropcols</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ea</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">norm_column</span><span class="p">,</span> <span class="n">process_column</span><span class="p">]]</span>

    <span class="n">gdf_points</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dropcols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># set defaults</span>
    <span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter_inc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Remove rows where data col is empty/null</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">[</span><span class="n">process_column</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nulls&#39;</span>
        <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">gdf_points</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;filter_inc&#39;</span><span class="p">]</span> \
            <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

    <span class="n">subset</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Remove duplicated geometries</span>
    <span class="c1"># https://github.com/geopandas/geopandas/issues/521#issuecomment-382806444</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">geom</span><span class="p">:</span> <span class="n">geom</span><span class="o">.</span><span class="n">wkb</span><span class="p">)</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">gdf_points</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Duplicate XY&#39;</span>
    <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">gdf_points</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;filter_inc&#39;</span><span class="p">]</span> \
        <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10,}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39;Remove Duplicate XYs&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span>

    <span class="n">subset</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">boundary_polyfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gdf_poly</span> <span class="o">=</span> <span class="n">ply_desc</span><span class="o">.</span><span class="n">open_geo_dataframe</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ply_desc</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">epsg</span> <span class="o">!=</span> <span class="n">points_crs</span><span class="o">.</span><span class="n">epsg_number</span><span class="p">:</span>
            <span class="c1"># Preference is to the projected coordinate system then only project the smaller</span>
            <span class="c1"># dataset (usually poly) By now points should be in the out projected coordinate system</span>
            <span class="k">if</span> <span class="n">ply_desc</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">epsg</span> <span class="o">!=</span> <span class="n">points_crs</span><span class="o">.</span><span class="n">epsg_number</span><span class="p">:</span>
                <span class="n">gdf_poly</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="n">points_crs</span><span class="o">.</span><span class="n">epsg_number</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;Reproject clip polygon&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;To epsg_number </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">points_crs</span><span class="o">.</span><span class="n">epsg_number</span><span class="p">),</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

        <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Clip to boundary then apply to filter column</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">gdf_poly</span><span class="o">.</span><span class="n">unary_union</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">gdf_poly</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GeometryError</span><span class="p">(</span><span class="s1">&#39;Clipping removed all features. Check coordinate systems and/or &#39;</span>
                                <span class="s1">&#39;clip polygon layer and try again&#39;</span><span class="p">)</span>
        <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">gdf_points</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;clip&#39;</span>
        <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">gdf_points</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;filter_inc&#39;</span><span class="p">]</span> \
            <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10,}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;Clip&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>
        <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">remove_zeros</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="n">process_column</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;zero&#39;</span>
        <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;filter_inc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GeometryError</span><span class="p">(</span><span class="s2">&quot;Zero filter removed all points &quot;</span>
                                <span class="s2">&quot;in column </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process_column</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">stdevs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Get a fresh copy of subset.</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">yld_mean</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">process_column</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">yld_std</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">process_column</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">subset</span><span class="p">[</span><span class="n">norm_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">process_column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">yld_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">yld_std</span><span class="p">)</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="n">norm_column</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">stdevs</span><span class="p">]</span>

            <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> std iter </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stdevs</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;filter_inc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">iterative</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10,}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39;Filter by column&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]),</span>
        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (zeros, norm, </span><span class="si">{}</span><span class="s2"> std)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">process_column</span><span class="p">,</span> <span class="n">stdevs</span><span class="p">),</span>
        <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

    <span class="n">gdf_thin</span> <span class="o">=</span> <span class="n">thin_point_by_distance</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()],</span>
                                      <span class="n">points_crs</span><span class="p">,</span> <span class="n">thin_dist_m</span><span class="p">)</span>

    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># update(join/merge) gdfPoints[&#39;filter&#39;] column with results from thinning.</span>
    <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdf_points</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gdf_thin</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_thin</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span>

    <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdf_points</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gdf_thin</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;filter_inc&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">gdf_thin</span><span class="p">[</span><span class="s1">&#39;filter_inc&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter_inc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

    <span class="k">del</span> <span class="n">gdf_thin</span>

    <span class="c1"># Add the incremental number to the filter column ie &#39;01 clip&#39;</span>
    <span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="p">[[</span><span class="s1">&#39;filter_inc&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># after last iteration of thin by distance subset should be</span>
    <span class="n">yld_mean</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="n">process_column</span><span class="p">]</span>
    <span class="n">yld_std</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">std</span><span class="p">()[</span><span class="n">process_column</span><span class="p">]</span>
    <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">norm_column</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">(</span><span class="n">gdf_points</span><span class="p">[</span><span class="n">process_column</span><span class="p">]</span> <span class="o">-</span> <span class="n">yld_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">yld_std</span>

    <span class="c1"># prepare some summary results for filtered features.</span>
    <span class="c1"># Filter is the reason a point is removed,and filter_inc keeps them in the order they were</span>
    <span class="c1"># removed. ie std it before thining by distance.</span>
    <span class="n">results_table</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">results_table</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;Pts remaining&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">results_table</span><span class="p">[</span><span class="s1">&#39;filter_inc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results_table</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get a count of features per filter. filter_inc maintains the sort order</span>
    <span class="n">results_table</span> <span class="o">=</span> <span class="n">results_table</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;filter_inc&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> \
        <span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;feat_count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">)</span>

    <span class="c1"># and add the total of the results</span>
    <span class="n">total_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="nb">len</span><span class="p">(</span><span class="n">results_table</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Total&#39;</span><span class="p">,</span>
                                    <span class="n">results_table</span><span class="p">[</span><span class="s1">&#39;feat_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()]],</span>
                             <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;filter_inc&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;feat_count&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;filter_inc&#39;</span><span class="p">)</span>

    <span class="c1"># Add this to results table</span>
    <span class="n">results_table</span> <span class="o">=</span> <span class="n">results_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_row</span><span class="p">)</span>

    <span class="c1"># Clean up filtered results by removing all columns except those new ones which</span>
    <span class="c1"># have to be copied back to original</span>
    <span class="n">dropcols</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ea</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">norm_column</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="n">id_col</span><span class="p">]]</span>

    <span class="n">gdf_points</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dropcols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Add x,y coordinates to match coordinate system</span>
    <span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;Easting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;Northing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    <span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;EN_EPSG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_crs</span><span class="o">.</span><span class="n">epsg_number</span>

    <span class="c1"># Clean up the original input dataframe and remove existing geometry and coord columns</span>
    <span class="n">alt_coord_columns</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_config_key</span><span class="p">(</span><span class="s1">&#39;geoCSV&#39;</span><span class="p">)[</span><span class="s1">&#39;xCoordinate_ColumnName&#39;</span><span class="p">]</span>
    <span class="n">alt_coord_columns</span> <span class="o">+=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_config_key</span><span class="p">(</span><span class="s1">&#39;geoCSV&#39;</span><span class="p">)[</span><span class="s1">&#39;yCoordinate_ColumnName&#39;</span><span class="p">]</span>

    <span class="c1"># Find and Drop coord columns if already exist.</span>
    <span class="n">coord_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">fld</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">fld</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">alt_coord_columns</span><span class="p">]</span>
    <span class="n">coord_columns</span> <span class="o">=</span> <span class="n">coord_columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">coord_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Use geopandas merge instead of concat to maintain coordinate system info etc.</span>
    <span class="n">gdf_final</span> <span class="o">=</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">id_col</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

    <span class="c1"># move newer columns to end (geometry, filter, etc)</span>
    <span class="n">gdf_final</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">id_col</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># get the appropriate file encoding and save the file</span>
    <span class="n">file_encoding</span> <span class="o">=</span> <span class="n">get_dataframe_encoding</span><span class="p">(</span><span class="n">gdf_final</span><span class="p">)</span>

    <span class="n">gdf_final</span><span class="p">[</span><span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csvfile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">file_encoding</span><span class="p">)</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10,}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39;Save to CSV&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_final</span><span class="p">[</span><span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">output_csvfile</span><span class="p">),</span> <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># gdfPoints have all points with a filter string assigned</span>
    <span class="k">if</span> <span class="n">out_keep_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">out_keep_shapefile</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_final</span><span class="p">[</span><span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                              <span class="n">out_keep_shapefile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10,}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;Save to Shapefile&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_final</span><span class="p">[</span><span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">out_keep_shapefile</span><span class="p">),</span> <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

        <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">out_removed_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">out_removed_shapefile</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_final</span><span class="p">[</span><span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
                              <span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">norm_column</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                              <span class="n">out_removed_shapefile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10,}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Save removed Shapefile&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_final</span><span class="p">[</span><span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">out_removed_shapefile</span><span class="p">),</span>
                            <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Results:---------------------------------------</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">results_table</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)))</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="se">\t</span><span class="si">{dur:&lt;15}</span><span class="se">\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                               <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">gdf_final</span><span class="p">[</span><span class="n">gdf_final</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()],</span> <span class="n">points_crs</span></div>


<div class="viewcode-block" id="random_pixel_selection"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.random_pixel_selection">[docs]</a><span class="k">def</span> <span class="nf">random_pixel_selection</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">raster_crs</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">out_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Select randomly distributed valid data pixels from a raster file and convert to points</span>
<span class="sd">    representing the center of the pixel. There is an option to save to shapefile if required.</span>

<span class="sd">    Note:</span>
<span class="sd">        When opening a raster using RasterIO the coordinate system is imported from the Proj4 string</span>
<span class="sd">         and converted to a crs_wkt. This means that the crs_wkt recorded against the opened dataset</span>
<span class="sd">          does not always equal the crs_wkt of the original raster file. To remedy this, use</span>
<span class="sd">          pyprecag_crs.getCRSfromRasterFile to create a crs object</span>

<span class="sd">    Args:</span>
<span class="sd">        raster (rasterio.io.DatasetReader):Opened raster file via rasterio.open(os.path.normpath())</span>
<span class="sd">        num_points (int): The number of random sample points to select.</span>
<span class="sd">        raster_crs (pyprecag_crs.crs): The Spatial Reference System for the raster file</span>
<span class="sd">        out_shapefile (str):Optional.. the path and name of a shapefile used to save the points.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.geodataframe.GeoDataFrame: A dataframe containing the select pixels as points</span>
<span class="sd">        pyprecag_crs.crs: The pyprecag CRS object of the points dataframe.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">DatasetReader</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input should be a rasterio.DatasetReader created &quot;</span>
                        <span class="s2">&quot;using rasterio.open(os.path.normpath())&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Size must be an Integer.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raster_crs</span><span class="p">,</span> <span class="n">pyprecag_crs</span><span class="o">.</span><span class="n">crs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Crs must be an instance of pyprecag.crs.crs&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_shapefile</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Output directory </span><span class="si">{}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_shapefile</span><span class="p">)))</span>

    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="n">out_shapefile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_randompts.shp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">())[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">band1</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_points</span> <span class="o">&gt;</span> <span class="n">band1</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Size parameter is greater than the number of data pixels&#39;</span><span class="p">)</span>

    <span class="c1"># Sources:  enumerate using a masked array https://stackoverflow.com/a/8621145</span>
    <span class="c1"># Create a geodataframe while iterating.... (Cell 2)</span>
    <span class="c1">#    http://nbviewer.jupyter.org/github/geopandas/geopandas/blob/master/examples/overlays.ipynb</span>

    <span class="c1"># Create a flattened mask array</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">band1</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1"># create an array with the row/col address and current pixel value for data pixels only</span>
    <span class="c1"># np.ndenumerate(image_read)   returns ((row,col),val) which can be unpacked</span>
    <span class="c1"># using ((r,c),v) and converted to a list using (int(r),int(c),v)</span>

    <span class="n">band1_index</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">v</span><span class="p">),</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">band1</span><span class="p">),</span> <span class="n">mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span><span class="p">]</span>

    <span class="c1"># get a fixes random sample</span>
    <span class="n">rand_samp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">band1_index</span><span class="p">,</span> <span class="n">num_points</span><span class="p">)</span>

    <span class="c1"># add coordinates for each sample point</span>
    <span class="n">rand_samp_xy</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span> <span class="o">+</span> <span class="n">raster</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">rand_samp</span><span class="p">]</span>

    <span class="c1"># convert to geopandas dataframe. Drop the data value from the output.</span>
    <span class="n">random_pts_gdf</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="p">([{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="s1">&#39;PtID&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">pt</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                    <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">pt</span><span class="p">[</span><span class="mi">4</span><span class="p">]}</span>
                                   <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rand_samp_xy</span><span class="p">)],</span> <span class="n">crs</span><span class="o">=</span><span class="n">raster_crs</span><span class="o">.</span><span class="n">epsg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">random_pts_gdf</span><span class="p">,</span> <span class="n">out_shapefile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">random_pts_gdf</span><span class="p">,</span> <span class="n">raster_crs</span></div>


<div class="viewcode-block" id="extract_pixel_statistics_for_points"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.extract_pixel_statistics_for_points">[docs]</a><span class="k">def</span> <span class="nf">extract_pixel_statistics_for_points</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">points_crs</span><span class="p">,</span> <span class="n">rasterfiles</span><span class="p">,</span>
                                        <span class="n">output_csvfile</span><span class="p">,</span> <span class="n">function_list</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">],</span> <span class="n">size_list</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Extract statistics from a list of rasters at set locations.</span>

<span class="sd">    All raster files in the list should be of the same pixel size. While multi-bands raster files</span>
<span class="sd">    are supported as an input, statistics will only be calculated and extracted for the first band.</span>

<span class="sd">    Statistics are calculated on pixel values with a square neighbourhood and saved to a CSV file.</span>

<span class="sd">    Pixels assigned with Nodata are converted to np.nan and excluded from the calculations.</span>

<span class="sd">    All original columns are included in the output csv file in addition to columns containing the</span>
<span class="sd">    values for each raster -&gt; size -&gt; statistic combination.  The column names can either be</span>
<span class="sd">    specified or derived via the out_colname argument in raster_ops.focal_statistics.</span>

<span class="sd">    A size of 1 can be used to extract exact pixel values and whereby no statistics are calculated.</span>

<span class="sd">    Args:</span>
<span class="sd">        points_geodataframe (geopandas.geodataframe.GeoDataFrame): The input points geodataframe of</span>
<span class="sd">                   locations to extract statistics.</span>
<span class="sd">        points_crs (pyprecag_crs.crs): The Spatial Reference System of the point_geodataframe</span>
<span class="sd">        rasterfiles (List[str]): the list of paths &amp; file names for the input rasters</span>
<span class="sd">        output_csvfile (str): the path and filename of the output CSV.</span>
<span class="sd">        function_list (List[function]): A list of statistical functions to apply to the raster.</span>
<span class="sd">                   These can include numpy functions like np.nanmean or custom ones like pixel_count</span>
<span class="sd">        size_list (List[int]): The list of neighbourhood sizes used to apply statistical filtering.</span>

<span class="sd">    Returns:</span>
<span class="sd">        geopandas.geodataframe.GeoDataFrame: dataframe of the points and calculated statistics</span>
<span class="sd">        pyprecag_crs.crs: The pyprecag CRS object of the points dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : inputGeodataFrame&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;POINT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="o">.</span><span class="n">geom_type</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : a points geopandas dataframe is required&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points_crs</span><span class="p">,</span> <span class="n">pyprecag_crs</span><span class="o">.</span><span class="n">crs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Crs must be an instance of pyprecag.crs.crs&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_csvfile</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">output_csvfile</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please specify an output CSV filename&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">output_csvfile</span><span class="p">):</span>
        <span class="c1"># if a path isn&#39;t provided then create in temp. Used for daisy chaining functions.</span>
        <span class="n">output_csvfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">output_csvfile</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_csvfile</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Output directory </span><span class="si">{}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_csvfile</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid Type: functions should be a list of function_list &#39;</span>
                        <span class="s1">&#39;statistics to process&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ea_function</span> <span class="ow">in</span> <span class="n">function_list</span><span class="p">:</span>
        <span class="c1"># check to see if the functions in the list are functions ie are callable not random</span>
        <span class="c1"># string or numbers....</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">ea_function</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid Type: should be a numpy or custom function like np.nanstd etc&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid Type: size_list should be a list of sizes to process&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ea_size</span> <span class="ow">in</span> <span class="n">size_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ea_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ea_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Size </span><span class="si">{}</span><span class="s2"> should be an odd integer. Only square &quot;</span>
                            <span class="s2">&quot;filters are supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ea_size</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rasterfiles</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid Type: rasterfiles should be a list&#39;</span><span class="p">)</span>

    <span class="n">not_exists</span> <span class="o">=</span> <span class="p">[</span><span class="n">my_file</span> <span class="k">for</span> <span class="n">my_file</span> <span class="ow">in</span> <span class="n">rasterfiles</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">my_file</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_exists</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;rasterfiles: </span><span class="si">{}</span><span class="s1"> raster file(s) do not exist</span><span class="se">\n\t</span><span class="s1">(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">not_exists</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">not_exists</span><span class="p">)))</span>

    <span class="c1"># Check that all raster files have the same pixel size_list.</span>
    <span class="n">pix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">res_error</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ea_raster</span> <span class="ow">in</span> <span class="n">rasterfiles</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ea_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pix</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">res</span>
            <span class="k">elif</span> <span class="n">pix</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">res</span><span class="p">:</span>
                <span class="n">res_error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ea_raster</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_error</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;rasterfiles: Inconsistent pixel sizes&#39;</span>
                        <span class="s1">&#39;</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res_error</span><span class="p">)))</span>

    <span class="sd">&#39;&#39;&#39;TODO: consider clipping raster to extent of the points file which will be quicker when </span>
<span class="sd">            the raster is larger than the points.&#39;&#39;&#39;</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># overwrite the gdf proj4 string with the epsg mapping equivalent</span>
    <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">points_crs</span><span class="o">.</span><span class="n">epsg</span>
    <span class="n">points_geodataframe</span><span class="p">[</span><span class="s1">&#39;EPSG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">points_crs</span><span class="o">.</span><span class="n">epsg_number</span>
    <span class="n">cur_pixel</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">size_list</span><span class="p">:</span>
        <span class="n">cur_pixel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">size_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ea_raster</span> <span class="ow">in</span> <span class="n">rasterfiles</span><span class="p">:</span>
        <span class="c1"># Need to get the wktproj of the raster from gdal NOT rasterio.</span>
        <span class="c1"># RasterIO works from the proj4 string NOT the wkt string so aussie zones details gets lost.</span>
        <span class="n">rast_crs</span> <span class="o">=</span> <span class="n">pyprecag_crs</span><span class="o">.</span><span class="n">getCRSfromRasterFile</span><span class="p">(</span><span class="n">ea_raster</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rast_crs</span><span class="o">.</span><span class="n">epsg</span> <span class="o">!=</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
            <span class="c1"># we have to reproject the vector points to match the raster</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;WARNING: Projecting points from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                                                                     <span class="n">rast_crs</span><span class="o">.</span><span class="n">epsg</span><span class="p">))</span>
            <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="n">rast_crs</span><span class="o">.</span><span class="n">epsg_number</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">focal_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ea_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cur_pixel</span><span class="p">:</span>
                <span class="n">focal_stats</span> <span class="o">+=</span> <span class="p">[</span><span class="n">focal_statistics</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">ea_size</span> <span class="ow">in</span> <span class="n">size_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ea_function</span> <span class="ow">in</span> <span class="n">function_list</span><span class="p">:</span>
                    <span class="n">focal_stats</span> <span class="o">+=</span> <span class="p">[</span><span class="n">focal_statistics</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ea_size</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">ea_function</span><span class="p">)]</span>

        <span class="c1"># Update the metadata for the desired focal_stats outputs.</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="s1">&#39;GTiff&#39;</span><span class="p">,</span> <span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">rast_crs</span><span class="o">.</span><span class="n">crs_wkt</span><span class="p">,</span>
                     <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">focal_stats</span><span class="p">)})</span>

        <span class="c1"># create a raster in memory</span>
        <span class="k">with</span> <span class="n">MemoryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">memfile</span><span class="p">:</span>
            <span class="c1"># open the in-memory raster for writing</span>
            <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
                <span class="c1"># loop through the outputs and write bands and tags</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">nm</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">focal_stats</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">update_tags</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">nm</span><span class="p">)</span>

            <span class="sd">&#39;&#39;&#39; https://gis.stackexchange.com/a/190428</span>
<span class="sd">             Get a generator object of  XY, value pairs to extract which can be used later by</span>
<span class="sd">              rasterio.sample() to extract values from ALL bands .... &#39;&#39;&#39;</span>
            <span class="n">pt_shapes</span> <span class="o">=</span> <span class="p">((</span><span class="n">geom</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>

            <span class="c1"># open the file for reading</span>
            <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
                <span class="c1"># using rasterio sample, extract values from each band at each point</span>
                <span class="n">raster_vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dest</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pt_shapes</span><span class="p">)]</span>

                <span class="c1"># extract the statistic type from the band tag name element</span>
                <span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">dest</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">i_band</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i_band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dest</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

            <span class="k">del</span> <span class="n">pt_shapes</span>

        <span class="c1"># Convert raster_vals numpy array to dataframe using tags as column names</span>
        <span class="n">df_raster_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">raster_vals</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">col_names</span><span class="p">)</span>

        <span class="c1"># replace values for points outside the raster extent with np.nan values</span>
        <span class="n">df_raster_vals</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">raster_vals</span>

        <span class="c1"># Add the point geometry back in by joining by row index</span>
        <span class="c1"># If Rounding&#39;s required do this.</span>
        <span class="c1"># points_geodataframe = pd.concat([points_geodataframe, df_raster_vals.round(6)], axis=1)</span>
        <span class="n">points_geodataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">df_raster_vals</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">df_raster_vals</span>

    <span class="c1"># Reproject points back to original coordinate system if required.</span>
    <span class="k">if</span> <span class="n">points_crs</span><span class="o">.</span><span class="n">epsg</span> <span class="o">!=</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
        <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="n">points_crs</span><span class="o">.</span><span class="n">epsg_number</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_csvfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># Save to CSV only points to KEEP using appropriate file encoding</span>
        <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csvfile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="se">\t</span><span class="si">{:&gt;10}</span><span class="s1">   </span><span class="si">{dur:&lt;15}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;Saved CSV&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">output_csvfile</span><span class="p">),</span>
            <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="se">\t</span><span class="si">{:&gt;10}</span><span class="s1"> </span><span class="si">{dur:&gt;15}</span><span class="se">\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">points_crs</span></div>


<div class="viewcode-block" id="multi_block_bands_processing"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.multi_block_bands_processing">[docs]</a><span class="k">def</span> <span class="nf">multi_block_bands_processing</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">,</span> <span class="n">band_nums</span><span class="o">=</span><span class="p">[],</span> <span class="n">image_epsg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">image_nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">polygon_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Derive multiple resampled image bands matching the specified pixel size and block grid extent</span>
<span class="sd">     for each shapefile polygon.</span>

<span class="sd">    Use this tool create individual band images for each polygon within a shapefile. A group-by</span>
<span class="sd">    column may be used to dissolve multiple polygons belonging to an individual block. The fitting</span>
<span class="sd">    of rasters to a base Block (grid) ensures for easier, more accurate multi-layered analysis</span>
<span class="sd">    required by in Precision Agriculture.</span>

<span class="sd">    The processing steps to achieve this are:</span>
<span class="sd">        - Dissolve polygons optionally using the group-by column</span>

<span class="sd">        Loop through each polygon feature and......</span>
<span class="sd">          - Create Block Grid</span>
<span class="sd">          - Clip image to polygon</span>
<span class="sd">          - Resample and fit to block grid for a pixel size and using Average resampling technique</span>
<span class="sd">          - Identify holes and fill if necessary</span>
<span class="sd">          - smooth image using a 5x5 pixel moving average (focal_statistics)</span>

<span class="sd">    If a polygon shapefile is not specified, polygons will be created from the images&#39; mask</span>

<span class="sd">    The polygon shapefile will be re-projected to match the image file</span>

<span class="sd">    A block grid will be created for each feature for the nominated pixel size and used as the base</span>
<span class="sd">    for analysis</span>

<span class="sd">    &quot;image_epsg&quot; and &quot;image_nodata&quot; can be used to set the coordinate system and image nodata values</span>
<span class="sd">     when they are not present within the image file.</span>

<span class="sd">    The output filename will consist of the selected band number or the value of a band&#39;s rasterio</span>
<span class="sd">    custom name tag</span>

<span class="sd">    Args:</span>
<span class="sd">        image_file (str): An input image</span>
<span class="sd">        pixel_size (int, float): The desired output pixel size in metres.</span>
<span class="sd">        out_folder (str): The output folder for the created images.</span>
<span class="sd">        band_nums  (List[int]): a list of band numbers to process. If empty all bands will be used</span>
<span class="sd">        image_epsg (int): the epsg number for the image. Only used if not provided by the image.</span>
<span class="sd">        image_nodata (int): the nodata value for the image. Only used if not provided by the image.</span>
<span class="sd">        polygon_shapefile (str): a polygon shapefile used to cut up an image.</span>
<span class="sd">        groupby (str):  the column/field to use to group multiple features.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[str]: a list of created files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">polygon_shapefile</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">polygon_shapefile</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">polygon_shapefile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">groupby</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">groupby</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">ea_arg</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;image_file&#39;</span><span class="p">,</span> <span class="n">image_file</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;out_folder&#39;</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">),</span>
                   <span class="p">(</span><span class="s1">&#39;polygon_shapefile&#39;</span><span class="p">,</span> <span class="n">polygon_shapefile</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="n">ea_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;polygon_shapefile&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is required &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not exist-Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

    <span class="k">for</span> <span class="n">ea_arg</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;pixel_size&#39;</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;image_nodata&#39;</span><span class="p">,</span> <span class="n">image_nodata</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> must be a integer or floating number - Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">ea_arg</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_epsg</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;image_epsg must be a integer - Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_epsg</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band_nums</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;band_nums must be a list of bands to resample&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">band_nums</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">band_nums</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image_bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span>
        <span class="n">band_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">band_nums</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">image_bands</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">band_check</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> are invalid bands.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">band_check</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">polygon_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vect_desc</span> <span class="o">=</span> <span class="n">VectorDescribe</span><span class="p">(</span><span class="n">polygon_shapefile</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;POLYGON&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vect_desc</span><span class="o">.</span><span class="n">geometry_type</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">GeometryError</span><span class="p">(</span><span class="s1">&#39;Invalid geometry. Input shapefile should be poly or multipolygon&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">groupby</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vect_desc</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input groupby column does not exist in the shapefile&#39;</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">vect_desc</span>

    <span class="n">pixel_size_str</span> <span class="o">=</span> <span class="n">numeric_pixelsize_to_string</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">)</span>
    <span class="n">filename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">))</span>
    <span class="n">temp_file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># ----------------------------------------------------------------------------------------------</span>
    <span class="c1"># Run coordinate system checks on the input image</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">image_file</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">image_epsg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">image_epsg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input coordinate system required - image_file does not contain&#39;</span>
                                 <span class="s1">&#39;a coordinate system, and in_epsg is 0&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image_epsg</span> <span class="o">=</span> <span class="n">pyprecag_crs</span><span class="o">.</span><span class="n">getCRSfromRasterFile</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="o">.</span><span class="n">epsg_number</span>

    <span class="c1"># ----------------------------------------------------------------------------------------------</span>
    <span class="c1"># run checks on input polygon, and if required reproject it to the raster coordinate system</span>
    <span class="n">gdf_poly</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">groupby</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">groupby</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">polygon_shapefile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># create a polygon from the image. hopefully by now the nodata val is correct.</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="c1"># source: https://gis.stackexchange.com/a/187883</span>
            <span class="c1"># Read dataset&#39;s valid data mask as a ndarray and extract from all bands (dataset_mask).</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">dataset_mask</span><span class="p">()</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">band</span> <span class="o">==</span> <span class="mi">255</span>  <span class="c1"># mask is where band == 255</span>

            <span class="c1"># Extract feature shapes and values from the array.</span>
            <span class="n">rast_shapes</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">shapes</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">geoms_geojson</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">val</span><span class="p">},</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">geom</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span>
                             <span class="nb">enumerate</span><span class="p">(</span><span class="n">rast_shapes</span><span class="p">)]</span>
            <span class="n">gdf_poly</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">geoms_geojson</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">from_epsg</span><span class="p">(</span><span class="n">image_epsg</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
                <span class="n">temp_file_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">BlockBoundary_</span><span class="si">{}</span><span class="s1">.shp&#39;</span>
                                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">image_epsg</span><span class="p">))]</span>

                <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_poly</span><span class="p">,</span> <span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">band</span><span class="p">,</span> <span class="n">rast_shapes</span><span class="p">,</span> <span class="n">geoms_geojson</span><span class="p">,</span> <span class="n">mask</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">desc_poly</span> <span class="o">=</span> <span class="n">VectorDescribe</span><span class="p">(</span><span class="n">polygon_shapefile</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;POLY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc_poly</span><span class="o">.</span><span class="n">geometry_type</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : a polygon shapefile is required&#39;</span><span class="p">)</span>

        <span class="n">gdf_poly</span> <span class="o">=</span> <span class="n">desc_poly</span><span class="o">.</span><span class="n">open_geo_dataframe</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">groupby</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf_poly</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Groupby column </span><span class="si">{}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groupby</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># change null/nones to blank string</span>
            <span class="n">gdf_poly</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># reproject shapefile to raster</span>
        <span class="n">poly_epsg</span> <span class="o">=</span> <span class="n">desc_poly</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">epsg_number</span>
        <span class="k">if</span> <span class="n">poly_epsg</span> <span class="o">!=</span> <span class="n">image_epsg</span><span class="p">:</span>
            <span class="c1"># we have to reproject the vector points to match the raster</span>
            <span class="nb">print</span> <span class="s1">&#39;WARNING: Projecting points from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc_poly</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">epsg</span><span class="p">,</span> <span class="n">image_epsg</span><span class="p">)</span>
            <span class="n">gdf_poly</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="n">image_epsg</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">poly_epsg</span> <span class="o">=</span> <span class="n">image_epsg</span>

        <span class="k">del</span> <span class="n">desc_poly</span>

        <span class="c1"># If a column name is specified, dissolve by this and create multi-polygons</span>
        <span class="c1"># otherwise dissolve without a column name at treat all features as one</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_poly</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gdf_poly</span> <span class="o">=</span> <span class="n">gdf_poly</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gdf_poly</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">gdf_poly</span><span class="o">.</span><span class="n">unary_union</span><span class="p">])</span>

    <span class="c1"># Loop through polygns features ----------------------------------------------------------------</span>
    <span class="n">output_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">gdf_poly</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">loop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_poly</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feat_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^0-9a-zA-Z]+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">feat</span><span class="p">[</span><span class="n">groupby</span><span class="p">]))</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">feat_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">feat_name</span> <span class="o">=</span> <span class="s1">&#39;No-Name&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feat_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># From shapes create a blockgrid mask. -----------------------------------------------------</span>
        <span class="n">blockgrid_memfile</span> <span class="o">=</span> <span class="n">MemoryFile</span><span class="p">()</span>
        <span class="n">meta_block</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">blockgrid</span><span class="p">,</span> <span class="n">new_blockmeta</span> <span class="o">=</span> <span class="n">convert_polygon_feature_to_raster</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">)</span>
        <span class="n">meta_block</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">new_blockmeta</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">blockgrid_memfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">**</span><span class="n">meta_block</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blockgrid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">blockgrid</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;Feature to block_grid&#39;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">,</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

            <span class="n">temp_file_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">BlockGrid_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pixel_size_str</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">))]</span>

            <span class="n">save_in_memory_raster_to_file</span><span class="p">(</span><span class="n">blockgrid_memfile</span><span class="p">,</span> <span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Clip Dataset. ---------------------------------------------------------------------</span>
        <span class="n">geoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">mapping</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">)]</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">crop_data</span><span class="p">,</span> <span class="n">crop_transform</span> <span class="o">=</span> <span class="n">rio_mask</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">geoms</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">iband</span> <span class="ow">in</span> <span class="n">band_nums</span><span class="p">:</span>  <span class="c1"># range(1, src.count + 1):</span>
                <span class="k">if</span> <span class="n">crop_data</span><span class="p">[</span><span class="n">iband</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="n">crop_data</span><span class="p">[</span><span class="n">iband</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">GeometryError</span><span class="p">(</span><span class="s2">&quot;There is no overlap between your polygon features &quot;</span>
                                        <span class="s2">&quot;and selected band(s)&quot;</span><span class="p">)</span>

            <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">crop_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                         <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">crop_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                         <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">crop_transform</span><span class="p">})</span>

            <span class="n">clip_memfile</span> <span class="o">=</span> <span class="n">MemoryFile</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">clip_memfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">crop_data</span><span class="p">)</span>
                <span class="c1"># reapply band tags to store the index name.</span>
                <span class="k">for</span> <span class="n">iband</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># image statistics have changed so don&#39;t copy the tags</span>
                    <span class="n">cleaned_tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">iband</span><span class="p">)</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span>
                         <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;STATISTIC&#39;</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleaned_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">update_tags</span><span class="p">(</span><span class="n">iband</span><span class="p">,</span> <span class="o">**</span><span class="n">cleaned_tags</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;Clipped Image to Feature&#39;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">,</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

            <span class="n">temp_file_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">crop_</span><span class="si">{}</span><span class="s1">.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">))]</span>

            <span class="n">save_in_memory_raster_to_file</span><span class="p">(</span><span class="n">clip_memfile</span><span class="p">,</span> <span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">crop_data</span><span class="p">,</span> <span class="n">crop_transform</span><span class="p">,</span> <span class="n">geoms</span>

        <span class="c1"># Resample to new pixel size using averaging -----------------------------------------------</span>
        <span class="k">with</span> <span class="n">clip_memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">meta_block</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">meta_block</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">meta_block</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]})</span>

            <span class="c1"># Resample all bands and write to file</span>
            <span class="n">resamp_memfile</span> <span class="o">=</span> <span class="n">MemoryFile</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">resamp_memfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iband</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">reproject</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">iband</span><span class="p">),</span>
                              <span class="n">src_transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
                              <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">iband</span><span class="p">),</span>
                              <span class="n">dst_transform</span><span class="o">=</span><span class="n">dest</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
                              <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">average</span><span class="p">)</span>

                    <span class="c1"># image statistics have changed so don&#39;t copy the tags</span>
                    <span class="n">cleaned_tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">iband</span><span class="p">)</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span>
                         <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;STATISTIC&#39;</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleaned_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">update_tags</span><span class="p">(</span><span class="n">iband</span><span class="p">,</span> <span class="o">**</span><span class="n">cleaned_tags</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;Resampled to </span><span class="si">{}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">),</span> <span class="n">status</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">,</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

            <span class="n">temp_file_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">resampleAV_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pixel_size_str</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">))]</span>

            <span class="n">save_in_memory_raster_to_file</span><span class="p">(</span><span class="n">resamp_memfile</span><span class="p">,</span> <span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">del</span> <span class="n">clip_memfile</span>

        <span class="c1"># get a count of holes to see if fill is required.</span>
        <span class="n">fillholes_memfile</span> <span class="o">=</span> <span class="n">MemoryFile</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">resamp_memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>

            <span class="n">apply_nodata</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span> <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="k">else</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span>

            <span class="k">with</span> <span class="n">blockgrid_memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">src_bg</span><span class="p">:</span>
                <span class="c1"># find holes where blockgrid has data and resample is nodata - this can be used as</span>
                <span class="c1"># the mask in the fillnodata at a later stage if required.</span>
                <span class="n">hole_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">((</span><span class="n">src_bg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                                            <span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">hole_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fillholes_memfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">**</span><span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">iband</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">iband</span><span class="p">)</span>

                        <span class="c1"># reapply block grid mask</span>
                        <span class="k">with</span> <span class="n">blockgrid_memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">src_bg</span><span class="p">:</span>
                            <span class="n">new_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">src_bg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                                                <span class="n">band</span><span class="p">,</span> <span class="n">apply_nodata</span><span class="p">)</span>

                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_band</span><span class="p">,</span> <span class="n">iband</span><span class="p">)</span>

                        <span class="c1"># image statistics have changed so don&#39;t copy the tags</span>
                        <span class="n">cleaned_tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">iband</span><span class="p">)</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
                                             <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;STATISTIC&#39;</span><span class="p">)])</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleaned_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">dest</span><span class="o">.</span><span class="n">update_tags</span><span class="p">(</span><span class="n">iband</span><span class="p">,</span> <span class="o">**</span><span class="n">cleaned_tags</span><span class="p">)</span>

            <span class="c1"># Fill holes ---------------------------------------------------------------------------</span>
            <span class="k">if</span> <span class="n">hole_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fillholes_memfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">**</span><span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">iband</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># for rasterio 1.0.3+ the mask= options will interpolate values for all</span>
                        <span class="c1"># designated nodata pixels (marked by zeros in `mask`)</span>
                        <span class="n">fill_nd</span> <span class="o">=</span> <span class="n">fillnodata</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">iband</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                             <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Dont use mask option</span>
                                             <span class="n">max_search_distance</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># default is 100</span>
                                             <span class="n">smoothing_iterations</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                        <span class="c1"># reapply block grid mask</span>
                        <span class="k">with</span> <span class="n">blockgrid_memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">src_bg</span><span class="p">:</span>
                            <span class="n">filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">src_bg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                                              <span class="n">fill_nd</span><span class="p">,</span> <span class="n">apply_nodata</span><span class="p">)</span>

                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filled</span><span class="p">,</span> <span class="n">iband</span><span class="p">)</span>
                        <span class="c1"># image statistics have changed so don&#39;t copy the tags</span>
                        <span class="n">cleaned_tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">iband</span><span class="p">)</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
                                             <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;STATISTIC&#39;</span><span class="p">)])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleaned_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">dest</span><span class="o">.</span><span class="n">update_tags</span><span class="p">(</span><span class="n">iband</span><span class="p">,</span> <span class="o">**</span><span class="n">cleaned_tags</span><span class="p">)</span>

                        <span class="k">del</span> <span class="n">fill_nd</span><span class="p">,</span> <span class="n">filled</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;Filled </span><span class="si">{}</span><span class="s1"> holes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hole_count</span><span class="p">),</span> <span class="n">status</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">,</span>
                    <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

                <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">temp_file_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">filled_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pixel_size_str</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">))]</span>

                <span class="n">save_in_memory_raster_to_file</span><span class="p">(</span><span class="n">fillholes_memfile</span><span class="p">,</span> <span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">del</span> <span class="n">resamp_memfile</span>

        <span class="c1"># Apply Focal Statistics to Smooth ---------------------------------------------------------</span>
        <span class="k">with</span> <span class="n">fillholes_memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
                <span class="n">temp_file_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">smoothed_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pixel_size_str</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">))]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iband</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">band_nums</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># range(1, src.count + 1):</span>
                <span class="n">smooth</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">focal_statistics</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">iband</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">clip_to_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># change np.nan to a number</span>
                <span class="n">smooth</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">smooth</span><span class="p">)]</span> <span class="o">=</span> <span class="n">apply_nodata</span>
                <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">get_minimum_dtype</span><span class="p">(</span><span class="n">smooth</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
                    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">band_nums</span><span class="p">))</span>
                    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">smooth</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                        <span class="c1"># image statistics have changed so don&#39;t copy the tags</span>
                        <span class="n">cleaned_tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
                                             <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;STATISTIC&#39;</span><span class="p">)])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleaned_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">dest</span><span class="o">.</span><span class="n">update_tags</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">cleaned_tags</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">iband</span><span class="p">):</span>
                    <span class="n">index_str</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">iband</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">index_str</span> <span class="o">=</span> <span class="s1">&#39;Band</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iband</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">feat_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">out_imagefile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index_str</span><span class="p">,</span> <span class="n">pixel_size_str</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_imagefile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feat_name</span><span class="p">,</span> <span class="n">index_str</span><span class="p">,</span> <span class="n">pixel_size_str</span><span class="p">)</span>

                <span class="n">out_imagefile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">out_imagefile</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">out_imagefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="n">out_imagefile</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">)</span>

                <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_imagefile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">tfw</span><span class="o">=</span><span class="s1">&#39;YES&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">,</span> \
                        <span class="n">rasterio</span><span class="o">.</span><span class="n">Env</span><span class="p">(</span><span class="n">GDAL_TIFF_INTERNAL_MASK</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">smooth</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># image statistics have changed so don&#39;t copy the tags</span>
                    <span class="n">cleaned_tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">iband</span><span class="p">)</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span>
                         <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;STATISTIC&#39;</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleaned_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">update_tags</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">cleaned_tags</span><span class="p">)</span>

                <span class="n">output_files</span> <span class="o">+=</span> <span class="p">[</span><span class="n">out_imagefile</span><span class="p">]</span>

                <span class="k">del</span> <span class="n">smooth</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;Smoothed and saved to </span><span class="si">{}</span><span class="s1"> file(s)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">band_nums</span><span class="p">)),</span>
                    <span class="n">status</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

                <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">del</span> <span class="n">fillholes_memfile</span><span class="p">,</span> <span class="n">blockgrid_memfile</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;Created </span><span class="si">{}</span><span class="s1"> files for feature&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">band_nums</span><span class="p">)),</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">feat_name</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">loop_time</span><span class="p">)))</span>

        <span class="c1"># del dest, src, src_bg</span>

    <span class="k">return</span> <span class="n">output_files</span></div>


<div class="viewcode-block" id="calc_indices_for_block"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.calc_indices_for_block">[docs]</a><span class="k">def</span> <span class="nf">calc_indices_for_block</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">band_map</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="p">[],</span> <span class="n">image_epsg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">image_nodata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">polygon_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_epsg</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate indices for a multi band image then resample to a specified pixel size</span>
<span class="sd">      and block grid extent for each shapefile polygon.</span>

<span class="sd">      Use this tool to create single band images, one for each index and shapefile polygon</span>
<span class="sd">      combination. A group-by column may be used to dissolve multiple polygons belonging to an</span>
<span class="sd">      individual block.</span>

<span class="sd">      If a polygon shapefile is not specified, polygons will be created from the images&#39; mask</span>

<span class="sd">      The polygon shapefile will be re-projected to match the image file</span>

<span class="sd">      A block grid will be created for each feature for the nominated pixel size and used as the</span>
<span class="sd">      base for analysis</span>

<span class="sd">      &quot;image_epsg&quot; and &quot;image_nodata&quot; can be used to set the coordinate system and image nodata</span>
<span class="sd">       values when they are not present within the image file.</span>

<span class="sd">      The output filename will consist of the selected feature and calculated index.</span>

<span class="sd">      The processing steps to achieve this are:</span>
<span class="sd">        - Reproject image to new coordinate system if required.</span>
<span class="sd">        - Calculate indices</span>
<span class="sd">        - Dissolve polygons optionally using the group-by column</span>

<span class="sd">        Loop through each polygon feature and......</span>
<span class="sd">          - Create Block Grid</span>
<span class="sd">          - Clip image to polygon</span>
<span class="sd">          - Resample and fit to block grid for a pixel size and using Average resampling technique</span>
<span class="sd">          - Identify holes and fill if necessary</span>
<span class="sd">          - smooth image using a 5x5 pixel moving average (focal_statistics)</span>

<span class="sd">    Args:</span>
<span class="sd">        image_file (str): the input image file</span>
<span class="sd">        pixel_size (int): the pixel size used for resampling</span>
<span class="sd">        band_map (pyprecag.bandops.BandMapping): A dictionary matching band numbers to</span>
<span class="sd">                                                band type (ie Red, Green, Blue etc.)</span>
<span class="sd">        out_folder (str): The output folder for the created images.</span>
<span class="sd">        indices (List[str]): The list of indices to calculate.</span>
<span class="sd">        image_epsg (int):  epsg number of the image to be used when missing in image</span>
<span class="sd">        image_nodata (int): nodata value of the image to be used when missing in image</span>
<span class="sd">        polygon_shapefile (str): a polygon shapefile used to cut up an image.</span>
<span class="sd">        groupby (str):  the column/field to use to group multiple features.</span>
<span class="sd">        out_epsg (int): The epsg number representing the coordinate system of the output images.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[str]: the list of created images.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">polygon_shapefile</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">polygon_shapefile</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">polygon_shapefile</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">ea_arg</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;image_file&#39;</span><span class="p">,</span> <span class="n">image_file</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;out_folder&#39;</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">),</span>
                   <span class="p">(</span><span class="s1">&#39;polygon_shapefile&#39;</span><span class="p">,</span> <span class="n">polygon_shapefile</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="n">ea_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;polygon_shapefile&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is required &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not exist-Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

    <span class="k">for</span> <span class="n">ea_arg</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;image_epsg&#39;</span><span class="p">,</span> <span class="n">image_epsg</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;out_epsg&#39;</span><span class="p">,</span> <span class="n">out_epsg</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> must be a integer - Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">ea_arg</span><span class="p">))</span>

    <span class="n">filename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">out_folder</span><span class="p">)</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">):</span>
        <span class="n">out_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_folder</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_reproj_&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                            <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">TEMPDIR</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_file</span><span class="p">:</span>
        <span class="n">reproj_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">new_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">reproject_image</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">reproj_image</span><span class="p">,</span> <span class="n">out_epsg</span><span class="p">,</span> <span class="n">image_nodata</span><span class="o">=</span><span class="n">image_nodata</span><span class="p">,</span>
                    <span class="n">image_epsg</span><span class="o">=</span><span class="n">image_epsg</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_indices_&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                            <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">TEMPDIR</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_file</span><span class="p">:</span>
        <span class="n">indices_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">new_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">calculate_image_indices</span><span class="p">(</span><span class="n">reproj_image</span><span class="p">,</span> <span class="n">band_map</span><span class="p">,</span> <span class="n">indices_image</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">polygon_shapefile</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">polygon_shapefile</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_BlockPolygons_&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                                <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">TEMPDIR</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_file</span><span class="p">:</span>
            <span class="n">polygon_shapefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">new_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># create a polygon from the image. hopefully by now the nodata val is correct.</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reproj_image</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">dataset_mask</span><span class="p">()</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">band</span> <span class="o">==</span> <span class="mi">255</span>  <span class="c1"># mask is where band == 255</span>

            <span class="c1"># Extract feature shapes and values from the array.</span>
            <span class="n">rast_shapes</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">shapes</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">geoms_geojson</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">val</span><span class="p">},</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">geom</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span>
                             <span class="nb">enumerate</span><span class="p">(</span><span class="n">rast_shapes</span><span class="p">)]</span>
            <span class="n">gdf_poly</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">geoms_geojson</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">from_epsg</span><span class="p">(</span><span class="n">image_epsg</span><span class="p">))</span>
            <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_poly</span><span class="p">,</span> <span class="n">polygon_shapefile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">band</span><span class="p">,</span> <span class="n">rast_shapes</span><span class="p">,</span> <span class="n">geoms_geojson</span><span class="p">,</span> <span class="n">mask</span>

    <span class="n">out_files</span> <span class="o">=</span> <span class="n">multi_block_bands_processing</span><span class="p">(</span><span class="n">indices_image</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">,</span>
                                             <span class="n">polygon_shapefile</span><span class="o">=</span><span class="n">polygon_shapefile</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">TEMPDIR</span> <span class="ow">in</span> <span class="n">indices_image</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">indices_image</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">TEMPDIR</span> <span class="ow">in</span> <span class="n">reproj_image</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">reproj_image</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">TEMPDIR</span> <span class="ow">in</span> <span class="n">polygon_shapefile</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">polygon_shapefile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_files</span></div>


<div class="viewcode-block" id="resample_bands_to_block"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.resample_bands_to_block">[docs]</a><span class="k">def</span> <span class="nf">resample_bands_to_block</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">,</span> <span class="n">band_nums</span><span class="o">=</span><span class="p">[],</span> <span class="n">image_epsg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">image_nodata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">polygon_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_epsg</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Derive multiple resampled image bands matching the specified pixel size and block grid extent</span>
<span class="sd">     for each shapefile polygon.</span>

<span class="sd">    Use this tool create individual band images for each polygon within a shapefile. A group-by</span>
<span class="sd">    column may be used to dissolve multiple polygons belonging to an individual block. The fitting</span>
<span class="sd">    of rasters to a base Block (grid) ensures for easier, more accurate multi-layered analysis</span>
<span class="sd">    required by in Precision Agriculture.</span>

<span class="sd">    The processing steps to achieve this are:</span>
<span class="sd">        - Reproject image to nominated coordinate system</span>
<span class="sd">        - Dissolve polygons optionally using the groupby column</span>

<span class="sd">        Loop through each polygon feature and......</span>
<span class="sd">          - Create Block Grid</span>
<span class="sd">          - Clip image to polygon</span>
<span class="sd">          - Resample and fit to block grid for a pixel size and using Average resampling technique</span>
<span class="sd">          - Identify holes and fill if necessary</span>
<span class="sd">          - smooth image using a 5x5 pixel moving average (focal_statistics)</span>

<span class="sd">    If a polygon shapefile is not specified, polygons will be created from the images&#39; mask</span>

<span class="sd">    The polygon shapefile will be re-projected to match the image file</span>

<span class="sd">    A block grid will be created for each feature for the nominated pixel size and used as the</span>
<span class="sd">    base for analysis</span>

<span class="sd">    &quot;image_epsg&quot; and &quot;image_nodata&quot; can be used to set the coordinate system and image nodata values</span>
<span class="sd">     when they are not present within the image file.</span>

<span class="sd">    The output filename will consist of the selected band number or the value of a band&#39;s rasterio</span>
<span class="sd">    custom name tag</span>

<span class="sd">    Args:</span>
<span class="sd">        image_file (str): An input image</span>
<span class="sd">        pixel_size (int, float): The desired output pixel size in metres.</span>
<span class="sd">        out_folder (str): The output folder for the created images.</span>
<span class="sd">        band_nums  (List[int]): a list of band numbers to process. If empty all bands will be used</span>
<span class="sd">        image_epsg (int):  epsg number of the image to be used when missing in image</span>
<span class="sd">        image_nodata (int): nodata value of the image to be used when missing in image</span>
<span class="sd">        polygon_shapefile (str): a polygon shapefile used to cut up an image.</span>
<span class="sd">        groupby (str):  the column/field to use to group multiple features.</span>
<span class="sd">        out_epsg (int): The epsg number representing the output coordinate system.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[str]: a list of created files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">filename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">ea_arg</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;image_file&#39;</span><span class="p">,</span> <span class="n">image_file</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;out_folder&#39;</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is required &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not exist-Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ea_arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">out_folder</span><span class="p">)</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">):</span>
        <span class="n">out_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_folder</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_reproj_&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                            <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">TEMPDIR</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_file</span><span class="p">:</span>
        <span class="n">reproj_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">new_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">reproject_image</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">reproj_image</span><span class="p">,</span> <span class="n">out_epsg</span><span class="p">,</span> <span class="n">image_nodata</span><span class="o">=</span><span class="n">image_nodata</span><span class="p">,</span>
                    <span class="n">image_epsg</span><span class="o">=</span><span class="n">image_epsg</span><span class="p">)</span>

    <span class="n">out_files</span> <span class="o">=</span> <span class="n">multi_block_bands_processing</span><span class="p">(</span><span class="n">reproj_image</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span>
                                             <span class="n">band_nums</span><span class="o">=</span><span class="n">band_nums</span><span class="p">,</span>
                                             <span class="n">polygon_shapefile</span><span class="o">=</span><span class="n">polygon_shapefile</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">TEMPDIR</span> <span class="ow">in</span> <span class="n">reproj_image</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">reproj_image</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_files</span></div>


<div class="viewcode-block" id="kmeans_clustering"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.kmeans_clustering">[docs]</a><span class="k">def</span> <span class="nf">kmeans_clustering</span><span class="p">(</span><span class="n">raster_files</span><span class="p">,</span> <span class="n">output_tif</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create zones with k-means clustering from multiple raster files as described in</span>


<span class="sd">    The input raster files should all:</span>
<span class="sd">        - have the same pixel size</span>
<span class="sd">        - be in the same coordinate system</span>
<span class="sd">        - should overlap</span>
<span class="sd">    Only the first band of each raster will be used.</span>

<span class="sd">    The output TIFF image extent will be the minimum overlapping extent of the input images.</span>
<span class="sd">    Each image will be resampled to a fixed coordinate to ensure pixels between images align.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_files (List[str]): The list of input raster files</span>
<span class="sd">        output_tif (str):   The output TIFF file</span>
<span class="sd">        n_clusters (int):  The number of clusters/zones to create.</span>
<span class="sd">        max_iterations (int): Maximum number of iterations for k-means algorithm in a single run.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.core.frame.DataFrame: A dataframe containing cluster statistics for each image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Size must be an Integer.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Size must be an Integer.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raster_files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid Type: raster_files should be a list&#39;</span><span class="p">)</span>

    <span class="n">not_exists</span> <span class="o">=</span> <span class="p">[</span><span class="n">my_file</span> <span class="k">for</span> <span class="n">my_file</span> <span class="ow">in</span> <span class="n">raster_files</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">my_file</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_exists</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;raster_files: </span><span class="si">{}</span><span class="s1"> raster file(s) do &#39;</span>
                      <span class="s1">&#39;not exist</span><span class="se">\n\t</span><span class="s1">(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_exists</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">not_exists</span><span class="p">)))</span>

    <span class="n">temp_file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">images_combined</span><span class="p">,</span> <span class="n">band_list</span> <span class="o">=</span> <span class="n">stack_and_clip_rasters</span><span class="p">(</span><span class="n">raster_files</span><span class="p">,</span>
                                                        <span class="n">output_tif</span><span class="o">=</span><span class="s1">&#39;1_kmeans_combined.tif&#39;</span><span class="p">)</span>
    <span class="n">temp_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images_combined</span><span class="p">)</span>

    <span class="c1"># Make sure ALL masks are saved inside the TIFF file not as a sidecar.</span>
    <span class="n">gdal</span><span class="o">.</span><span class="n">SetConfigOption</span><span class="p">(</span><span class="s1">&#39;GDAL_TIFF_INTERNAL_MASK&#39;</span><span class="p">,</span> <span class="s1">&#39;YES&#39;</span><span class="p">)</span>

    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Extract data ready for k-means ------------------------------------------------</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">images_combined</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">template_band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">stack_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">bands</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ea_band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
            <span class="n">new_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">ea_band</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>
            <span class="n">data_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">ea_band</span><span class="p">))</span>

        <span class="n">data_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_stack</span><span class="p">)</span>

    <span class="c1"># Now we need to whiten and/or normalise the data prior to clustering</span>
    <span class="c1"># This ensures each variable carries the same weight despite different input data ranges</span>
    <span class="n">norm_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">data_stack</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="c1"># write mask to file</span>
        <span class="n">temp_file_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">TEMPDIR</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_kmeans_normalised_image.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))]</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">stack_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp_dst</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ea</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">norm_stack</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1"># recreate the full array dimensions</span>
                <span class="n">new_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">template_band</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">new_band</span><span class="p">,</span> <span class="o">~</span><span class="n">new_band</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">ea</span><span class="p">)</span>

                <span class="c1"># reapply the mask to remove values assigned to nodata pixels</span>
                <span class="n">new_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">new_band</span><span class="p">,</span> <span class="n">tmp_dst</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>
                <span class="n">tmp_dst</span><span class="o">.</span><span class="n">update_tags</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">band_list</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

                <span class="n">tmp_dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_band</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">tmp_dst</span><span class="o">.</span><span class="n">descriptions</span> <span class="o">=</span> <span class="n">band_list</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Images Normalised&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                 <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>
        <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Run the k-means clustering -------------------------------------------------------------------</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">kmeans2</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">norm_stack</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">max_iterations</span><span class="p">,</span> <span class="n">minit</span><span class="o">=</span><span class="s1">&#39;points&#39;</span><span class="p">)</span>

    <span class="c1"># adjust the class values to start from 1 so 0 can be used as nodata</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">code</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Write to file</span>
    <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">template_band</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">,</span> <span class="o">~</span><span class="n">cluster_data</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># set nodata to 0</span>
    <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">cluster_dtype</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">get_minimum_dtype</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cluster_data</span><span class="p">)</span>

    <span class="n">cluster_meta</span> <span class="o">=</span> <span class="n">stack_meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cluster_meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">cluster_dtype</span><span class="p">})</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_tif</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">cluster_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cluster_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">cluster_dtype</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Clustering complete&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                             <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>
    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># create summary statistics --------------------------------------------------------------------</span>

    <span class="c1"># create a table to store statistics</span>
    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">])</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_tif</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_clust</span><span class="p">,</span> \
            <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">images_combined</span><span class="p">)</span> <span class="k">as</span> <span class="n">src_img</span><span class="p">:</span>

        <span class="c1"># get the list of clusters to process</span>
        <span class="n">clust_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">src_clust</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="n">clust_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">src_clust</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>

        <span class="n">bands</span> <span class="o">=</span> <span class="n">src_img</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ea_clust</span> <span class="ow">in</span> <span class="n">clust_list</span><span class="p">:</span>
            <span class="c1"># get pixels for each cluster</span>
            <span class="n">clust_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">src_clust</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="n">ea_clust</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">new_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">ea_clust</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">])</span>
            <span class="n">img_meta</span> <span class="o">=</span> <span class="n">src_img</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">MemoryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">memfile</span><span class="p">:</span>
                <span class="c1"># apply cluster mask to all bands</span>
                <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">**</span><span class="n">img_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp_dst</span><span class="p">:</span>
                    <span class="n">tmp_dst</span><span class="o">.</span><span class="n">write_mask</span><span class="p">(</span><span class="n">clust_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">img_meta</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]))</span>
                    <span class="n">tmp_dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_src</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ea_band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp_src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
                        <span class="n">new_row</span><span class="p">[</span><span class="n">src_img</span><span class="o">.</span><span class="n">descriptions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ea_band</span><span class="p">)</span>
                        <span class="n">new_row</span><span class="p">[</span><span class="n">src_img</span><span class="o">.</span><span class="n">descriptions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">ea_band</span><span class="p">)</span>

            <span class="c1"># for pandas 0.23.4 add sort=False to prevent row and column orders to change.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results_df</span> <span class="o">=</span> <span class="n">new_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">results_df</span> <span class="o">=</span> <span class="n">new_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Move &#39;Zone&#39; to the first column - fixed in pandas 0.23.4 by adding sort=False to append</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">columns</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">columns</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;zone&#39;</span><span class="p">)))</span>
        <span class="n">results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zone&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># write to csv without &#39;, &#39; to assist when loading into ESRI</span>
        <span class="n">col_names</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_tif</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;_statistics.csv&#39;</span><span class="p">),</span>
                          <span class="n">header</span><span class="o">=</span><span class="n">col_names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># format the table and print to log.</span>
        <span class="n">results_df_copy</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">col_names</span> <span class="o">=</span> <span class="n">results_df_copy</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># replace column name NaNs to &#39;....&#39;. &#39;....&#39; as multiple spaces aren&#39;t allowed</span>
        <span class="n">results_df_copy</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
            <span class="p">[(</span><span class="s1">&#39;.......&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">])</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Cluster Statistics:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">results_df_copy</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">justify</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>

        <span class="k">del</span> <span class="n">results_df_copy</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur:&lt;15}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39;Saved Stats CSV&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_tif</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;_statistics.csv&#39;</span><span class="p">),</span>
        <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

    <span class="c1"># clean up of intermediate files</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">temp_file_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">ea</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">gdal</span><span class="o">.</span><span class="n">SetConfigOption</span><span class="p">(</span><span class="s1">&#39;GDAL_TIFF_INTERNAL_MASK&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1">  </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur:&lt;15}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39;K-Means Clustering Completed&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> zones for </span><span class="si">{}</span><span class="s1"> rasters&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">n_clusters</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">raster_files</span><span class="p">)),</span> <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">results_df</span></div>


<div class="viewcode-block" id="create_points_along_line"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.create_points_along_line">[docs]</a><span class="k">def</span> <span class="nf">create_points_along_line</span><span class="p">(</span><span class="n">lines_geodataframe</span><span class="p">,</span> <span class="n">lines_crs</span><span class="p">,</span> <span class="n">distance_between_points</span><span class="p">,</span>
                             <span class="n">offset_distance</span><span class="p">,</span> <span class="n">out_epsg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_points_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">out_lines_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add points along a line using a specified distance and create left/right parallel points</span>
<span class="sd">        offset by a distance.</span>

<span class="sd">        If the lines are in a geographic coordinate system they will be re-projected to a projected</span>
<span class="sd">        coordinate system.</span>

<span class="sd">        All touching lines will be treated as one.</span>
<span class="sd">        MultiPart geometry will be converted to single part geometry.</span>
<span class="sd">        The first and last points will be offset from start/end of the line evenly.</span>
<span class="sd">        Attributes from the input lines will be lost.</span>

<span class="sd">        line_crs is used to ensure that the correct wkt definition is maintained when using</span>
<span class="sd">        geopandas.</span>

<span class="sd">        Args:</span>
<span class="sd">            lines_geodataframe (geopandas.geodataframe.GeoDataFrame): A Geopandas dataframe</span>
<span class="sd">                             containing Lines</span>
<span class="sd">            lines_crs (pyprecag.crs.crs): The detailed coordinate system</span>

<span class="sd">            distance_between_points (int): The separation distance between points.</span>

<span class="sd">            offset_distance (int): The distance between the Strip point and parallel point.</span>

<span class="sd">            out_epsg (int): Optionally specify the epsg number for the output coordinate system.</span>
<span class="sd">                            This should be a project coordinate system</span>

<span class="sd">            out_points_shapefile (str): Optionally specify shapefile path and filename used to</span>
<span class="sd">                            save the points to. If a path is not supplied, it will save the file</span>
<span class="sd">                            to TEMPDIR  by default.</span>

<span class="sd">            out_lines_shapefile (str): Optionally specify shapefile path and filename used to save</span>
<span class="sd">                            the lines to. If a path is not supplied, it will save the file to</span>
<span class="sd">                            TEMPDIR  by default</span>
<span class="sd">        Returns:</span>
<span class="sd">             geopandas.geodataframe.GeoDataFrame: The geodataframe containing the created points.</span>
<span class="sd">             pyprecag.crs.crs: The coordinate system of both the points and lines geodataframe.</span>
<span class="sd">             geopandas.geodataframe.GeoDataFrame: The geodataframe containing the created lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lines_geodataframe</span><span class="p">,</span> <span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : inputGeodataFrame&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;LINE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">lines_geodataframe</span><span class="o">.</span><span class="n">geom_type</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">GeometryError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : A lines geopandas dataframe is required&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">argCheck</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;offset_distance&#39;</span><span class="p">,</span> <span class="n">offset_distance</span><span class="p">),</span>
                     <span class="p">(</span><span class="s1">&#39;distance_between_points&#39;</span><span class="p">,</span> <span class="n">distance_between_points</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argCheck</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> must be a floating number.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argCheck</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lines_crs</span><span class="p">,</span> <span class="n">pyprecag_crs</span><span class="o">.</span><span class="n">crs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Crs must be an instance of pyprecag.crs.crs&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_epsg</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;out_epsg must be a integer - Got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">out_epsg</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">out_points_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">out_points_shapefile</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_points_shapefile</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="s1">&#39;Output directory </span><span class="si">{}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_points_shapefile</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">out_lines_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">out_lines_shapefile</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_lines_shapefile</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="s1">&#39;Output directory </span><span class="si">{}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">out_lines_shapefile</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">out_points_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">out_lines_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out_points_shapefile</span> <span class="o">==</span> <span class="n">out_lines_shapefile</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Output points and lines shapefile names are identical&#39;</span><span class="p">)</span>

    <span class="c1"># create temp files template</span>
    <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;strip_treatment_&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">TEMPDIR</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_file</span><span class="p">:</span>
        <span class="n">temp_filename</span> <span class="o">=</span> <span class="n">new_file</span><span class="o">.</span><span class="n">name</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">out_epsg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Make sure we get the correct details for the output coordinate system</span>
        <span class="n">points_crs</span> <span class="o">=</span> <span class="n">pyprecag_crs</span><span class="o">.</span><span class="n">crs</span><span class="p">()</span>
        <span class="n">points_crs</span><span class="o">.</span><span class="n">getFromEPSG</span><span class="p">(</span><span class="n">out_epsg</span><span class="p">)</span>

    <span class="c1"># overwrite the gdf proj4 string with the epsg mapping equivalent to maintain the correct wkt.</span>
    <span class="n">lines_geodataframe</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">lines_crs</span><span class="o">.</span><span class="n">epsg</span>

    <span class="k">if</span> <span class="n">out_epsg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Make sure we get the correct details for the output coordinate system</span>
        <span class="n">points_crs</span> <span class="o">=</span> <span class="n">pyprecag_crs</span><span class="o">.</span><span class="n">crs</span><span class="p">()</span>
        <span class="n">points_crs</span><span class="o">.</span><span class="n">getFromEPSG</span><span class="p">(</span><span class="n">out_epsg</span><span class="p">)</span>

    <span class="c1"># input needs to be a projected coordinate system to work with metric distances</span>
    <span class="k">if</span> <span class="n">lines_crs</span><span class="o">.</span><span class="n">srs</span><span class="o">.</span><span class="n">IsGeographic</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">out_epsg</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lines_geodataframe</span><span class="o">.</span><span class="n">total_bounds</span>
            <span class="n">points_crs</span> <span class="o">=</span> <span class="n">pyprecag_crs</span><span class="o">.</span><span class="n">getProjectedCRSForXY</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">lines_crs</span><span class="o">.</span><span class="n">epsg_number</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">points_crs</span> <span class="o">=</span> <span class="n">lines_crs</span>

    <span class="c1"># project if required.</span>
    <span class="k">if</span> <span class="n">lines_crs</span><span class="o">.</span><span class="n">epsg_number</span> <span class="o">!=</span> <span class="n">points_crs</span><span class="o">.</span><span class="n">epsg_number</span><span class="p">:</span>
        <span class="n">lines_geodataframe</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="n">points_crs</span><span class="o">.</span><span class="n">epsg_number</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;Reproject lines To epsg </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">points_crs</span><span class="o">.</span><span class="n">epsg_number</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>
    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># merge touching lines</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines_geodataframe</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">linemerge</span><span class="p">(</span><span class="n">lines_geodataframe</span><span class="o">.</span><span class="n">unary_union</span><span class="p">)],</span>
                                 <span class="n">crs</span><span class="o">=</span><span class="n">lines_geodataframe</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">lines_geodataframe</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># convert multi part to single part geometry</span>
    <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">gdf_lines</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gdf_lines</span><span class="p">,</span> <span class="n">GeoSeries</span><span class="p">):</span>
        <span class="c1">#  geopandas 0.3.0 explode creates a geoseries so convert back to geodataframe</span>
        <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">gdf_lines</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">lines_geodataframe</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1"># explode creates a multi index so flatten to single level</span>
    <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">gdf_lines</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;level_0&#39;</span><span class="p">,</span> <span class="s1">&#39;level_1&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># assign a name to the index column</span>
    <span class="n">gdf_lines</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;FID&#39;</span>

    <span class="k">if</span> <span class="n">gdf_lines</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">has_z</span><span class="p">:</span>
        <span class="n">gdf_lines</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_lines</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">drop_z</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c1"># Add TrialID  Side, Length and startoffset</span>
    <span class="k">if</span> <span class="s1">&#39;TrialID&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf_lines</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">gdf_lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;TrialID&#39;</span><span class="p">,</span> <span class="n">gdf_lines</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gdf_lines</span><span class="p">[</span><span class="s1">&#39;TrialID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_lines</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># Add Side, Length and startoffset attributes</span>
    <span class="n">gdf_lines</span><span class="p">[</span><span class="s1">&#39;Strip_Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Strip&#39;</span>

    <span class="c1"># find dangle length when the line isn&#39;t evenly divided by the point distance</span>
    <span class="c1"># Calculate the length of each line</span>
    <span class="n">gdf_lines</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_lines</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>

    <span class="c1"># calculate a start offset to centre points along the line</span>
    <span class="n">gdf_lines</span><span class="p">[</span><span class="s1">&#39;startoffset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdf_lines</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span> <span class="o">%</span> <span class="n">distance_between_points</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># create a new dataframe for parallel lines</span>
    <span class="n">gdf_lrline</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FID&#39;</span><span class="p">,</span> <span class="s1">&#39;TrialID&#39;</span><span class="p">,</span> <span class="s1">&#39;Strip_Name&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">],</span>
                              <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">gdf_lines</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1"># create L/R lines for each centre line</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">c_line_row</span> <span class="ow">in</span> <span class="n">gdf_lines</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">c_line_geom</span> <span class="o">=</span> <span class="n">c_line_row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">line_bearing</span> <span class="o">=</span> <span class="n">point_to_point_bearing</span><span class="p">(</span><span class="n">c_line_geom</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                              <span class="n">c_line_geom</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ea_line</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Strip&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deg_to_8_compass_pts</span><span class="p">(</span><span class="n">line_bearing</span> <span class="o">-</span> <span class="mi">90</span><span class="p">))),</span>
                        <span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Strip&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deg_to_8_compass_pts</span><span class="p">(</span><span class="n">line_bearing</span> <span class="o">+</span> <span class="mi">90</span><span class="p">)))]:</span>

            <span class="n">side</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">ea_line</span>

            <span class="c1"># update the geometry and TrialID.</span>
            <span class="n">parallel_line</span> <span class="o">=</span> <span class="n">c_line_geom</span><span class="o">.</span><span class="n">parallel_offset</span><span class="p">(</span><span class="n">offset_distance</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                                                        <span class="n">join_style</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mitre_limit</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
            <span class="n">parallel_line</span> <span class="o">=</span> <span class="n">parallel_line</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">preserve_topology</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># One of the lines needs to be flipped</span>
            <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
                <span class="n">parallel_line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span><span class="n">parallel_line</span><span class="o">.</span><span class="n">coords</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">gdf_lrline</span> <span class="o">=</span> <span class="n">gdf_lrline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;TrialID&#39;</span><span class="p">:</span> <span class="n">c_line_row</span><span class="p">[</span><span class="s1">&#39;TrialID&#39;</span><span class="p">],</span>
                                            <span class="s1">&#39;Strip_Name&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">parallel_line</span><span class="p">},</span>
                                           <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">gdf_lrline</span><span class="p">[</span><span class="s1">&#39;FID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_lrline</span><span class="o">.</span><span class="n">index</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1">   </span><span class="si">{:&lt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;Parallel lines created&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span><span class="p">)))</span>

    <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Create an empty dataframe to store points in</span>
    <span class="n">gdf_points</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FID&#39;</span><span class="p">,</span> <span class="s1">&#39;TrialID&#39;</span><span class="p">,</span> <span class="s1">&#39;Strip_Name&#39;</span><span class="p">,</span> <span class="s1">&#39;PointID&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">],</span>
                              <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span>
                              <span class="n">crs</span><span class="o">=</span><span class="n">gdf_lrline</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1"># Loop through each centre line</span>
    <span class="k">for</span> <span class="n">index_c</span><span class="p">,</span> <span class="n">line_c</span> <span class="ow">in</span> <span class="n">gdf_lines</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">line_c</span><span class="p">[</span><span class="s1">&#39;startoffset&#39;</span><span class="p">]</span>
        <span class="n">ptid</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">line_c</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]:</span>
            <span class="c1"># Add point along the centre line.</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">line_c</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>

            <span class="c1"># add it to the dataframe</span>
            <span class="n">gdf_points</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">pt</span><span class="p">,</span>
                                            <span class="s1">&#39;TrialID&#39;</span><span class="p">:</span> <span class="n">line_c</span><span class="p">[</span><span class="s1">&#39;TrialID&#39;</span><span class="p">],</span>
                                            <span class="s1">&#39;PointID&#39;</span><span class="p">:</span> <span class="n">ptid</span><span class="p">,</span>
                                            <span class="s1">&#39;Strip_Name&#39;</span><span class="p">:</span> <span class="n">line_c</span><span class="p">[</span><span class="s1">&#39;Strip_Name&#39;</span><span class="p">],</span>
                                            <span class="s1">&#39;DistOnLine&#39;</span><span class="p">:</span> <span class="n">distance</span><span class="p">},</span>
                                           <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># To add points to Offset lines, first find corresponding lines.</span>
            <span class="n">line_subset</span> <span class="o">=</span> <span class="n">gdf_lrline</span><span class="p">[</span><span class="n">gdf_lrline</span><span class="p">[</span><span class="s1">&#39;TrialID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">line_c</span><span class="p">[</span><span class="s1">&#39;TrialID&#39;</span><span class="p">]]</span>

            <span class="k">for</span> <span class="n">index_lr</span><span class="p">,</span> <span class="n">line_lr</span> <span class="ow">in</span> <span class="n">line_subset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="c1"># find the distance along the L/R line of the corresponding centre line point</span>
                <span class="n">dist_along_line</span> <span class="o">=</span> <span class="n">line_lr</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>

                <span class="c1"># Add a new point feature. Interpolate locates the xy based on the distance</span>
                <span class="c1"># along the line.</span>
                <span class="n">gdf_points</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">line_lr</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">dist_along_line</span><span class="p">),</span>
                     <span class="s1">&#39;TrialID&#39;</span><span class="p">:</span> <span class="n">line_c</span><span class="p">[</span><span class="s1">&#39;TrialID&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;PointID&#39;</span><span class="p">:</span> <span class="n">ptid</span><span class="p">,</span>
                     <span class="s1">&#39;Strip_Name&#39;</span><span class="p">:</span> <span class="n">line_lr</span><span class="p">[</span><span class="s1">&#39;Strip_Name&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;DistOnLine&#39;</span><span class="p">:</span> <span class="n">distance</span><span class="p">},</span>
                    <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">distance</span> <span class="o">+=</span> <span class="n">distance_between_points</span>
            <span class="n">ptid</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># add a feature identifier</span>
    <span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;FID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># combine to original centre line while only keeping common columns and calculate length</span>
    <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gdf_lines</span><span class="p">,</span> <span class="n">gdf_lrline</span><span class="p">],</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                          <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;TrialID&#39;</span><span class="p">,</span> <span class="s1">&#39;Strip_Name&#39;</span><span class="p">])</span>

    <span class="n">gdf_lines</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_lines</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>

    <span class="k">if</span> <span class="n">out_lines_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">out_lines_shapefile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_lines</span><span class="p">,</span> <span class="n">temp_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="s1">&#39;_lines.shp&#39;</span><span class="p">),</span>
                                  <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_lines</span><span class="p">,</span> <span class="n">out_lines_shapefile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out_points_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">out_points_shapefile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">,</span> <span class="n">temp_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="s1">&#39;_points.shp&#39;</span><span class="p">),</span>
                                  <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">save_geopandas_tofile</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">,</span> <span class="n">out_points_shapefile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;Create Points Along Line Completed&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">gdf_points</span><span class="p">,</span> <span class="n">points_crs</span><span class="p">,</span> <span class="n">gdf_lines</span></div>


<div class="viewcode-block" id="ttest_analysis"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.ttest_analysis">[docs]</a><span class="k">def</span> <span class="nf">ttest_analysis</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">points_crs</span><span class="p">,</span> <span class="n">values_raster</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">,</span>
                   <span class="n">zone_raster</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">control_raster</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a moving window t-test analysis for a strip trial as described in Lawes</span>
<span class="sd">    and Bramley (2012).</span>

<span class="sd">    Format of the points must be from the create_points_along_line tools.</span>
<span class="sd">    All input rasters must be of the same coordinate system and pixel size and overlap with the</span>
<span class="sd">    points.</span>

<span class="sd">    Output statistics include:</span>
<span class="sd">        controls_mean  - row by row mean of the control columns</span>
<span class="sd">        treat_diff -   row by row difference between the treatment and controls_mean columns</span>
<span class="sd">        av_treat_diff - calculate mean of values using a moving window using the treat_diff column</span>
<span class="sd">        p_value - calculate  p_value using a moving window using treatment and controls_mean columns</span>
<span class="sd">        RI  - Response Index using the treatment and controls_mean columns</span>

<span class="sd">    Output Files include:</span>
<span class="sd">        For each line and strip combination :</span>
<span class="sd">            - png Map showing orientation of the line (start and ends)</span>
<span class="sd">            - png set of graphs</span>
<span class="sd">            - CSV file of derived statistics.</span>
<span class="sd">    Reference:</span>
<span class="sd">        Lawes RA, Bramley RGV. 2012. A Simple Method for the Analysis of On-Farm Strip Trials.</span>
<span class="sd">         Agronomy Journal 104, 371-377.</span>

<span class="sd">    Args:</span>
<span class="sd">        points_geodataframe (geopandas.geodataframe.GeoDataFrame): points derived using</span>
<span class="sd">                create_points_along_line</span>
<span class="sd">        points_crs (pyprecag.crs.crs):the coordinate system for the points.</span>
<span class="sd">        values_raster (str): a kriged raster containing the treatment  values</span>
<span class="sd">        out_folder (str):  folder for output files.</span>
<span class="sd">        zone_raster (str): a raster containing zones.</span>
<span class="sd">        control_raster (str): a kriged raster of</span>
<span class="sd">        size (int): the size used to calculate the moving window statistics.</span>
<span class="sd">        create_graph (bool):</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.core.frame.DataFrame: dataframe containing output statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : inputGeodataFrame&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;POINT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="o">.</span><span class="n">geom_type</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">GeometryError</span><span class="p">(</span><span class="s1">&#39;Invalid input data : a points geopandas dataframe is required&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points_crs</span><span class="p">,</span> <span class="n">pyprecag_crs</span><span class="o">.</span><span class="n">crs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Crs must be an instance of pyprecag.crs.crs&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out_folder</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">out_folder</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please specify an output folder&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_folder</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Output directory </span><span class="si">{}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_folder</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>  <span class="c1"># or size % 2 == 0   - odd numbers only</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Size </span><span class="si">{}</span><span class="s2"> should be an integer.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">zone_raster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">zone_raster</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">control_raster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">control_raster</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">not_exists</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="p">[</span><span class="n">values_raster</span><span class="p">,</span> <span class="n">control_raster</span><span class="p">,</span> <span class="n">zone_raster</span><span class="p">]</span> <span class="k">if</span> <span class="n">ea</span> <span class="ow">and</span>
                  <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ea</span><span class="p">)]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_exists</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;raster files: </span><span class="si">{}</span><span class="s1"> raster file(s) &#39;</span>
                      <span class="s1">&#39;do not exist</span><span class="se">\n\t</span><span class="s1">(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_exists</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">not_exists</span><span class="p">)))</span>
    <span class="k">del</span> <span class="n">not_exists</span>

    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TrialID&#39;</span><span class="p">,</span> <span class="s1">&#39;PointID&#39;</span><span class="p">,</span> <span class="s1">&#39;Strip_Name&#39;</span><span class="p">,</span> <span class="s1">&#39;DistOnLine&#39;</span><span class="p">]</span>
               <span class="k">if</span> <span class="n">ea</span> <span class="ow">and</span> <span class="n">ea</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points_geodataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;columns not found - </span><span class="si">{}</span><span class="s2">. Please use the output from the &quot;</span>
                         <span class="s2">&quot;create_points_along_line. (PAT&#39;s create strip trial points)&quot;</span>
                         <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">),</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)))</span>

    <span class="k">del</span> <span class="n">missing</span>

    <span class="c1"># get list of valid rasters</span>
    <span class="n">raster_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="p">[</span><span class="n">values_raster</span><span class="p">,</span> <span class="n">control_raster</span><span class="p">,</span> <span class="n">zone_raster</span><span class="p">]</span> <span class="k">if</span> <span class="n">ea</span><span class="p">]</span>

    <span class="c1"># make sure rasters overlap  ------------------------------------</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ea_raster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">raster_files</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ea_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>

                <span class="n">band1</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># get minimum data extent</span>
                <span class="n">data_window</span> <span class="o">=</span> <span class="n">get_data_window</span><span class="p">(</span><span class="n">band1</span><span class="p">)</span>

                <span class="c1"># find the intersection of all the windows</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">min_window</span> <span class="o">=</span> <span class="n">data_window</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># create a new window using the last coordinates based on this image in case</span>
                    <span class="c1"># extents/pixel origins are different</span>
                    <span class="n">min_img_window</span> <span class="o">=</span> <span class="n">from_bounds</span><span class="p">(</span><span class="o">*</span><span class="n">min_bbox</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>

                    <span class="c1"># find the intersection of the windows.</span>
                    <span class="n">min_window</span> <span class="o">=</span> <span class="n">intersection</span><span class="p">(</span><span class="n">min_img_window</span><span class="p">,</span> <span class="n">data_window</span><span class="p">)</span><span class="o">.</span><span class="n">round_lengths</span><span class="p">(</span><span class="s1">&#39;ceil&#39;</span><span class="p">)</span>

                <span class="c1"># convert the window co coordinates</span>
                <span class="n">min_bbox</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">window_bounds</span><span class="p">(</span><span class="n">min_window</span><span class="p">)</span>

                <span class="k">del</span> <span class="n">min_window</span>

    <span class="k">except</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">WindowError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># reword &#39;windows do not intersect&#39; error message</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Rasters do not overlap&quot;</span><span class="p">,)</span>
        <span class="k">raise</span>  <span class="c1"># re-raise current exception</span>

    <span class="n">transect_column</span> <span class="o">=</span> <span class="s1">&#39;Strip_Name&#39;</span>
    <span class="n">x_axis_column</span> <span class="o">=</span> <span class="s1">&#39;DistOnLine&#39;</span>

    <span class="n">line_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="p">[</span><span class="s1">&#39;TrialID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

    <span class="c1"># Extract raster values for points ------------------------------------------------------------</span>

    <span class="n">gdf_points</span><span class="p">,</span> <span class="n">points_crs</span> <span class="o">=</span> <span class="n">extract_pixel_statistics_for_points</span><span class="p">(</span><span class="n">points_geodataframe</span><span class="p">,</span> <span class="n">points_crs</span><span class="p">,</span>
                                                                 <span class="n">raster_files</span><span class="p">,</span> <span class="s1">&#39;extract_pixels.csv&#39;</span><span class="p">,</span>
                                                                 <span class="n">size_list</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">gdf_points</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;rowID&#39;</span>
    <span class="n">column_names</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># find the columns relating to the rasters</span>
    <span class="k">if</span> <span class="n">values_raster</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">rastname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">values_raster</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">eaString</span> <span class="k">for</span> <span class="n">eaString</span> <span class="ow">in</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">columns</span>
                                     <span class="k">if</span> <span class="n">rastname</span> <span class="ow">in</span> <span class="n">eaString</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">control_raster</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">rastname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">control_raster</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">eaString</span> <span class="k">for</span> <span class="n">eaString</span> <span class="ow">in</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">columns</span>
                                       <span class="k">if</span> <span class="n">rastname</span> <span class="ow">in</span> <span class="n">eaString</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">zone_raster</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">rastname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">zone_raster</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Zone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">eaString</span> <span class="k">for</span> <span class="n">eaString</span> <span class="ow">in</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">columns</span>
                                    <span class="k">if</span> <span class="n">rastname</span> <span class="ow">in</span> <span class="n">eaString</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Add a zone col with a constant value</span>
        <span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;Zone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Zone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Zone&#39;</span>

    <span class="c1"># rename columns from raster name to the dictionary key to be more generic</span>
    <span class="n">gdf_points</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">([[</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">column_names</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># create a unique id for each line/point</span>
    <span class="n">gdf_points</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;TrialPtID&#39;</span><span class="p">,</span>
                      <span class="n">gdf_points</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;TrialID&#39;</span><span class="p">],</span>
                                                                  <span class="n">x</span><span class="p">[</span><span class="s1">&#39;PointID&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Apply bearing to all transects</span>
    <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">gdf_group</span> <span class="ow">in</span> <span class="n">gdf_points</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;TrialID&#39;</span><span class="p">,</span> <span class="n">transect_column</span><span class="p">]):</span>
        <span class="n">gdf_group</span> <span class="o">=</span> <span class="n">gdf_group</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">gdf_group</span><span class="p">[</span><span class="s1">&#39;geom2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_group</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
        <span class="n">gdf_group</span><span class="p">[</span><span class="s1">&#39;label_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_group</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geom2&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">text_rotation</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;geom2&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># update the main dataframe - needs matching indexes</span>
        <span class="n">gdf_points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdf_points</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gdf_group</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;label_angle&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">gdf_group</span><span class="p">[[</span><span class="s1">&#39;label_angle&#39;</span><span class="p">]]</span>

    <span class="k">del</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">gdf_group</span>

    <span class="n">offset_names</span> <span class="o">=</span> <span class="n">gdf_points</span><span class="p">[</span><span class="s1">&#39;Strip_Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">strip_name</span> <span class="o">=</span> <span class="n">offset_names</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">offset_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Strip&#39;</span><span class="p">))</span>

    <span class="c1"># pivot/transpose the table.</span>
    <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">)</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;TrialPtID&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">transect_column</span><span class="p">,</span>
                                              <span class="n">values</span><span class="o">=</span><span class="n">column_names</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># clean up un required columns</span>
    <span class="k">if</span> <span class="n">control_raster</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># only keep offset strips</span>
        <span class="n">dropcols</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Control&#39;</span><span class="p">,</span> <span class="n">strip_name</span><span class="p">)]</span>
        <span class="n">dropcols</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span> <span class="n">ea</span><span class="p">)</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">offset_names</span><span class="p">]</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dropcols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># change the order before joining levels together</span>
    <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Fix column headers</span>
    <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="sd">&#39;&#39;&#39; Ensure zone columns are integer. cant be integer and contain NAN&#39;s so do it later.</span>
<span class="sd">     TODO: In v0.24, you can now do df = df.astype(pd.Int32Dtype())</span>
<span class="sd">     http://pandas.pydata.org/pandas-docs/stable/user_guide/integer_na.html</span>
<span class="sd">     df_pivot[column_names[&#39;Zone&#39;]] = df_pivot[column_names[&#39;Zone&#39;]].astype(pd.Int8Dtype())&#39;&#39;&#39;</span>

    <span class="c1"># Prepare to join tables --------------------------------------------------------------------</span>
    <span class="c1"># drop geometry etc. and create flat table.</span>
    <span class="n">df_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">gdf_points</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="c1"># Keep only minimum of columns</span>
    <span class="n">dropcols</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">df_table</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
                <span class="n">ea</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FID&#39;</span><span class="p">,</span> <span class="s1">&#39;TrialPtID&#39;</span><span class="p">,</span> <span class="s1">&#39;TrialID&#39;</span><span class="p">,</span> <span class="s1">&#39;PointID&#39;</span><span class="p">,</span> <span class="s1">&#39;DistOnLine&#39;</span><span class="p">]]</span>

    <span class="n">df_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dropcols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># remove duplicate points only keeping first - ie the Strip</span>
    <span class="n">df_table</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TrialPtID&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># add pivot columns back to original table --------------------------------------------------</span>
    <span class="n">df_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_table</span><span class="p">,</span> <span class="n">df_pivot</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;TrialPtID&#39;</span><span class="p">)</span>

    <span class="n">pivot_columns</span> <span class="o">=</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">del</span> <span class="n">df_pivot</span>

    <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
    <span class="c1"># suppress ImportError: No module named _tkinter, please install the python-tk package</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="c1"># Suppress interactive plotting</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>

    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">gridspec</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
    <span class="kn">import</span> <span class="nn">matplotlib.patheffects</span> <span class="k">as</span> <span class="nn">pe</span>

    <span class="k">for</span> <span class="n">iline</span><span class="p">,</span> <span class="p">(</span><span class="n">line_id</span><span class="p">,</span> <span class="n">gdf_strip</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gdf_points</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;TrialID&#39;</span><span class="p">]),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iline</span><span class="p">,</span> <span class="n">line_count</span><span class="p">)</span>
        <span class="n">loop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">df_subtable</span> <span class="o">=</span> <span class="n">df_table</span><span class="p">[</span><span class="n">df_table</span><span class="p">[</span><span class="s1">&#39;TrialID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">line_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">offset_names</span> <span class="o">=</span> <span class="n">gdf_strip</span><span class="p">[</span><span class="s1">&#39;Strip_Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">strip_name</span> <span class="o">=</span> <span class="n">offset_names</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">offset_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Strip&#39;</span><span class="p">))</span>

        <span class="c1"># determine which columns to use</span>
        <span class="n">keepcols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pivot_columns</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">keepcols</span> <span class="o">+=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">offset_names</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pivot_columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">dropcols</span> <span class="o">=</span> <span class="p">[</span><span class="n">ea</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">pivot_columns</span> <span class="k">if</span> <span class="n">ea</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keepcols</span><span class="p">]</span>

        <span class="n">column_names</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">keepcols</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ea</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">column_names</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Zone&#39;</span><span class="p">:</span>
                <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">column_names</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>

        <span class="n">df_subtable</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dropcols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Convert zones to integer - there should be no NAN&#39;s</span>
        <span class="n">df_subtable</span><span class="p">[</span><span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Zone&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_subtable</span><span class="p">[</span><span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Zone&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># run loop for the three scenarios. 1) both sides (N+S), 2) North, 3) South</span>
        <span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span><span class="n">offset_names</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset_names</span>
        <span class="k">for</span> <span class="n">iscenario</span><span class="p">,</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">scenario</span> <span class="o">=</span> <span class="p">[</span><span class="n">scenario</span><span class="p">]</span>

            <span class="n">control_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scenario</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Control&#39;</span><span class="p">]</span>
                           <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
            <span class="n">valid_zone_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scenario</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Strip&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Zone&#39;</span><span class="p">]</span>
                              <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>

            <span class="n">dropcols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Control&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">control_col</span> <span class="o">+</span> <span class="n">valid_zone_col</span> <span class="o">+</span> <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]]</span>
            <span class="n">dropcols</span> <span class="o">+=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Zone&#39;</span><span class="p">]</span>
                         <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">control_col</span> <span class="o">+</span> <span class="n">valid_zone_col</span> <span class="o">+</span> <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]]</span>

            <span class="n">offset_subst</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ea</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">control_col</span><span class="p">])</span>
            <span class="n">file_path_noext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;Trial-</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">-strip&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_id</span><span class="p">,</span>
                                                                                  <span class="n">offset_subst</span><span class="p">))</span>

            <span class="n">df_statstable</span><span class="p">,</span> <span class="n">control_mean</span> <span class="o">=</span> <span class="n">calculate_strip_stats</span><span class="p">(</span><span class="n">df_subtable</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dropcols</span><span class="p">),</span>
                                                                <span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                                <span class="n">control_col</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

            <span class="n">df_statstable</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FID&#39;</span><span class="p">,</span> <span class="s1">&#39;TrialPtID&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                <span class="n">file_path_noext</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="se">\t</span><span class="si">{:&gt;10}</span><span class="s1">   </span><span class="si">{dur:&lt;15}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;Saved CSV&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">file_path_noext</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span>
                    <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">loop_time</span><span class="p">)))</span>

            <span class="sd">&#39;&#39;&#39; Create the map &amp; graphs ---------------------------------------------------------</span>
<span class="sd">            https://stackoverflow.com/a/39694347</span>
<span class="sd">            https://stackoverflow.com/a/14887119&#39;&#39;&#39;</span>

            <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]</span>
            <span class="n">colour_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="n">zone_column</span> <span class="o">=</span> <span class="s1">&#39;Strip Zone&#39;</span>

            <span class="c1"># add plotting parameters to table -----------------------------------------------</span>
            <span class="c1"># assign an id to the column</span>
            <span class="n">df_statstable</span><span class="p">[</span><span class="s1">&#39;zone_UID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_statstable</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">zone_column</span><span class="p">)</span><span class="o">.</span><span class="n">grouper</span><span class="o">.</span><span class="n">group_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># assign a marker based on the index from the list</span>
            <span class="n">df_statstable</span><span class="p">[</span><span class="s2">&quot;zone_marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_statstable</span><span class="p">[</span><span class="s1">&#39;zone_UID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">markers</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

            <span class="c1"># drop nan&#39;s introduced by the rolling window</span>
            <span class="n">df_statstable</span> <span class="o">=</span> <span class="n">df_statstable</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;av_treat_dif&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># only get those points geometry with rolling window results.</span>
            <span class="n">gdf_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gdf_strip</span><span class="p">,</span> <span class="n">df_statstable</span><span class="p">[[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]],</span>
                               <span class="n">on</span><span class="o">=</span><span class="s1">&#39;TrialPtID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;FID&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># ,&#39;label_angle&#39;</span>

            <span class="c1"># get y axis limits</span>
            <span class="n">min_ylimit</span> <span class="o">=</span> <span class="n">df_statstable</span><span class="p">[</span><span class="s1">&#39;av_treat_dif&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">max_ylimit</span> <span class="o">=</span> <span class="n">df_statstable</span><span class="p">[</span><span class="s1">&#39;av_treat_dif&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">use_pvalue</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="n">df_statstable</span><span class="p">[</span><span class="s1">&#39;sig_color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_statstable</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;r&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">use_pvalue</span> <span class="k">else</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">df_statstable</span><span class="p">[</span><span class="s1">&#39;sig_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_statstable</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;not significant&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">use_pvalue</span> <span class="k">else</span> <span class="s1">&#39;significant&#39;</span><span class="p">)</span>

            <span class="c1"># Create the map only once for both lines ----------------------------------------------</span>
            <span class="k">if</span> <span class="n">iscenario</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># get start middle and ends of lines for labelling</span>
                <span class="n">start_end_pts</span> <span class="o">=</span> <span class="n">gdf_map</span><span class="p">[</span><span class="n">gdf_map</span><span class="p">[</span><span class="n">transect_column</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Strip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">middle_pts</span> <span class="o">=</span> <span class="n">gdf_map</span><span class="p">[</span><span class="n">gdf_map</span><span class="p">[</span><span class="s1">&#39;PointID&#39;</span><span class="p">]</span> <span class="o">==</span>
                                     <span class="n">gdf_map</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf_map</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)][</span><span class="s1">&#39;PointID&#39;</span><span class="p">]]</span>

                <span class="c1"># create lines</span>

                <span class="c1"># Aggregate points with the GroupBy - for shapely 1.3.2+ use the point objects</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">gdf_map</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Strip_Name&#39;</span><span class="p">])[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">LineString</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">gdf_map</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Strip_Name&#39;</span><span class="p">])[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">LineString</span><span class="p">([(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]))</span>

                <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">gdf_lines</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>

                <span class="n">fig_map</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

                <span class="c1"># fix the extent to the vector</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Map for Trial </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_id</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">gdf_strip</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span>
                            <span class="n">right</span><span class="o">=</span><span class="n">gdf_strip</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="n">gdf_strip</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span>
                            <span class="n">top</span><span class="o">=</span><span class="n">gdf_strip</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span>

                <span class="c1"># plot the line</span>
                <span class="n">gdf_lines</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;rainbow&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># _ = gdf_map.plot(ax=ax,marker=&#39;o&#39;,column=&#39;Strip_Name&#39;,cmap=&#39;rainbow&#39;,markersize=5)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="c1"># ,top=True,labeltop=True,bottom=False,labelbottom=False)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:,.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:,.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                <span class="c1"># plt.xticks(rotation=&#39;vertical&#39;)</span>

                <span class="n">anno_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;va&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;ha&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;path_effects&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pe</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)]}</span>

                <span class="n">middle_pts</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Strip_Name&#39;</span><span class="p">],</span>
                                                       <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
                                                       <span class="n">rotation</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;label_angle&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">anno_kwargs</span><span class="p">),</span>
                                 <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">start_end_pts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                         <span class="n">start_end_pts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
                            <span class="n">rotation</span><span class="o">=</span><span class="n">start_end_pts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;label_angle&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">anno_kwargs</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;End&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">start_end_pts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                       <span class="n">start_end_pts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
                            <span class="n">rotation</span><span class="o">=</span><span class="n">start_end_pts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;label_angle&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">anno_kwargs</span><span class="p">)</span>

                <span class="n">map_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_folder</span><span class="p">,</span> <span class="s2">&quot;Trial-</span><span class="si">{}</span><span class="s2">_map.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_id</span><span class="p">))</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">map_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="se">\t</span><span class="si">{:&gt;10}</span><span class="s1">   </span><span class="si">{dur:&lt;15}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s1">&#39;Map Saved&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">map_file</span><span class="p">,</span> <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">loop_time</span><span class="p">)))</span>

            <span class="c1"># Create the graphs ----------------------------------------------</span>
            <span class="n">fig_graph</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1"># width, height</span>
            <span class="n">fig_graph</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

            <span class="n">axs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">igs</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">igs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_graph</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ss</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_graph</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="c1"># add a title</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Strip trial analysis for Trial </span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1"> strip&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_id</span><span class="p">,</span> <span class="n">offset_subst</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">use_pvalue</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

            <span class="n">df_statstable</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;DistOnLine&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">column_names</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Treatment&#39;</span><span class="p">)</span>  <span class="c1"># ,colormap=&#39;rainbow&#39;, figsize=(25, 5))</span>

            <span class="n">df_statstable</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;DistOnLine&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">control_mean</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Control&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_statstable</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Strip Zone&#39;</span><span class="p">,</span> <span class="s1">&#39;zone_marker&#39;</span><span class="p">,</span> <span class="s1">&#39;sig_color&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;sig_label&#39;</span><span class="p">]):</span>
                <span class="n">group</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;DistOnLine&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;av_treat_dif&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                   <span class="n">c</span><span class="o">=</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Zone </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>  <span class="c1"># ,s=25</span>

                <span class="n">group</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;DistOnLine&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;RI&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                   <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Zone </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># s=25</span>

                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
                    <span class="n">group</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;DistOnLine&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;p_value&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                       <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Zone </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Treatment Units&quot;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Treatment Difference&quot;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Response</span><span class="se">\n</span><span class="s2">Index&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;p value&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ea</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">]):</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">ea</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colour_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;p=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">iax</span><span class="p">,</span> <span class="n">ea_ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">):</span>
                <span class="n">ea_ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
                <span class="n">ea_ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Distance (m) from start of strip (see map)&quot;</span><span class="p">)</span>
                <span class="c1"># increase graph outline</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ea_ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Shrink current axis by 20%  https://stackoverflow.com/a/4701285</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">ea_ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
                <span class="n">ea_ax</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">box</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
                <span class="n">ea_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

                <span class="c1"># remove duplicates labels from legend  https://stackoverflow.com/a/13589144</span>
                <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ea_ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
                <span class="n">by_label</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iax</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ea_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span>
                                 <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                    <span class="c1"># title=&#39;Using a p-value of {} &#39;.format(use_pvalue))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ea_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span>
                                 <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_path_noext</span> <span class="o">+</span> <span class="s1">&#39;_graph.png&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="se">\t</span><span class="si">{:&gt;10}</span><span class="s1">   </span><span class="si">{dur:&lt;15}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;Saved graph&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">file_path_noext</span> <span class="o">+</span> <span class="s1">&#39;_graph.png&#39;</span><span class="p">,</span>
                    <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">loop_time</span><span class="p">)))</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39;T-Test for Line </span><span class="si">{}</span><span class="s1"> Completed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_id</span><span class="p">),</span> <span class="n">status</span><span class="p">,</span>
            <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">loop_time</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">df_table</span></div>


<div class="viewcode-block" id="persistor_all_years"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.persistor_all_years">[docs]</a><span class="k">def</span> <span class="nf">persistor_all_years</span><span class="p">(</span><span class="n">raster_files</span><span class="p">,</span> <span class="n">output_tif</span><span class="p">,</span> <span class="n">greater_than</span><span class="p">,</span> <span class="n">target_percentage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine the performance persistence of yield by across multiple years as described in</span>
<span class="sd">    Bramley and Hamilton (2005)</span>

<span class="sd">    The &quot;Target over all years&quot; method assigns a value to each pixel to indicate the number of</span>
<span class="sd">    instances (in the raster list) in which that pixel was either less than or greater than</span>
<span class="sd">    the mean (+/- a nominated percentage) of that raster.</span>

<span class="sd">     All input rasters MUST overlap and have the same coordinate system and pixel size.</span>

<span class="sd">     If a path is omitted from output_tif it will be created in your temp folder.</span>

<span class="sd">    References:</span>
<span class="sd">        Bramley RGV, Hamilton RP (2005) Understanding variability in winegrape production systems</span>
<span class="sd">        1. Within vineyard variation in yield over several vintages. Australian Journal Of Grape And</span>
<span class="sd">        Wine Research 10, 32-45. doi:10.1111/j.1755-0238.2004.tb00006.x.</span>

<span class="sd">    Args:</span>
<span class="sd">        raster_files (List[str]): List of rasters to use as inputs</span>
<span class="sd">        output_tif (str): Output TIF file</span>
<span class="sd">        greater_than (bool): if true test above (gt) the mean</span>
<span class="sd">        target_percentage (int): the percent variation either above/below the mean.</span>
<span class="sd">                   This should be a integer between -50 and 50</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The output tif name</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_percentage</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;target_percentage must an integer between -50 to 50.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">target_percentage</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">50</span> <span class="ow">or</span> <span class="n">target_percentage</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;target_percentage must an integer between -50 to 50.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">greater_than</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;greater_than must be boolean.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_tif</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">output_tif</span><span class="p">):</span>
        <span class="n">output_tif</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">output_tif</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raster_files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid Type: raster_files should be a list&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raster_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid Type: Empty list of raster files&#39;</span><span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># combine and align grid and slip to common area</span>
    <span class="n">image_combined</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stack_and_clip_rasters</span><span class="p">(</span><span class="n">raster_files</span><span class="p">,</span> <span class="n">use_common</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">output_tif</span><span class="o">=</span><span class="s1">&#39;allyrs_combined.tif&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_combined</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">band</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">band</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">target_percentage</span> <span class="o">/</span> <span class="mf">100.00</span><span class="p">))</span>
            <span class="n">band_new</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># classify bands</span>
            <span class="k">if</span> <span class="n">greater_than</span><span class="p">:</span>
                <span class="n">band_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">band</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">band_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">band</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># reapply nodata values</span>
            <span class="n">band_new</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
            <span class="n">band_new</span> <span class="o">=</span> <span class="n">band_new</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

            <span class="c1"># cumulative sum of bands</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sum_of_rasters</span> <span class="o">=</span> <span class="n">band_new</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sum_of_rasters</span> <span class="o">=</span> <span class="n">sum_of_rasters</span> <span class="o">+</span> <span class="n">band_new</span>

            <span class="n">sum_of_rasters</span><span class="p">[</span><span class="n">band</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>

            <span class="k">del</span> <span class="n">band</span><span class="p">,</span> <span class="n">band_new</span>

    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">})</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_tif</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst_allyrs</span><span class="p">:</span>
        <span class="n">dst_allyrs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sum_of_rasters</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">arg_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span> <span class="k">if</span> <span class="n">greater_than</span> <span class="k">else</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">target_percentage</span><span class="p">)</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Persistor All Years Completed&#39;</span><span class="p">,</span> <span class="n">arg_str</span><span class="p">,</span>
                                             <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span>

    <span class="c1"># cleanup Temp files</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">()</span> <span class="ow">and</span> <span class="n">TEMPDIR</span> <span class="ow">in</span> <span class="n">image_combined</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">image_combined</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_tif</span></div>


<div class="viewcode-block" id="persistor_target_probability"><a class="viewcode-back" href="../../reference/pyprecag.processing.html#pyprecag.processing.persistor_target_probability">[docs]</a><span class="k">def</span> <span class="nf">persistor_target_probability</span><span class="p">(</span><span class="n">upper_raster_files</span><span class="p">,</span> <span class="n">upper_percentage</span><span class="p">,</span> <span class="n">upper_probability</span><span class="p">,</span>
                                 <span class="n">lower_raster_files</span><span class="p">,</span> <span class="n">lower_percentage</span><span class="p">,</span> <span class="n">lower_probability</span><span class="p">,</span>
                                 <span class="n">output_tif</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine the probability of a performance being exceeded or not being met with an upper and</span>
<span class="sd">     lower limit as described in Bramley and Hamilton (2005).</span>

<span class="sd">    The &quot;Target probability&quot; method builds on the target over all years method, in that it includes</span>
<span class="sd">    an upper range (i.e. cells with a given frequency of values that are above the mean +/- a</span>
<span class="sd">     given percentage) and a lower range (i.e. cells with a given frequency of values that are</span>
<span class="sd">     below the mean +/- a given percentage).</span>

<span class="sd">    A value is assigned to each pixel which indicates whether the performance in that pixel over</span>
<span class="sd">    a given proportion of years is:</span>
<span class="sd">        a)	Greater than the mean plus or minus the nominated percentage (value = 1)</span>
<span class="sd">        b)	Less than the mean plus or minus the nominated percentage (value = -1)</span>
<span class="sd">        The remaining pixels which do not fall into category a) or b) are given a value of 0.</span>

<span class="sd">    All input rasters MUST overlap and have the same coordinate system and pixel size.</span>

<span class="sd">    If a path is omitted from output_tif it will be created in your temp folder.</span>

<span class="sd">    References:</span>
<span class="sd">        Bramley RGV, Hamilton RP (2005) Understanding variability in winegrape production systems</span>
<span class="sd">        1. Within vineyard variation in yield over several vintages. Australian Journal Of Grape</span>
<span class="sd">        And Wine Research 10, 32-45. doi:10.1111/j.1755-0238.2004.tb00006.x.</span>

<span class="sd">    Args:</span>
<span class="sd">        upper_raster_files (List[str]): List of rasters to used for the analysis of the</span>
<span class="sd">                    UPPER category</span>
<span class="sd">        upper_percentage (int): the percent variation either above/below the mean to apply</span>
<span class="sd">                    to the UPPER raster category.</span>
<span class="sd">        upper_probability (int):the probability percentage to apply to the LOWER category</span>

<span class="sd">        lower_raster_files (List[str]): List of rasters to used for the analysis of the</span>
<span class="sd">                    LOWER category</span>
<span class="sd">        lower_percentage (int): the percent variation either above/below the mean to apply</span>
<span class="sd">                    to the LOWER raster category.</span>
<span class="sd">        lower_probability (int): the probability percentage to apply to the LOWER category</span>

<span class="sd">        output_tif (str): Output TIF file</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">arg_check</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;upper_raster_files&#39;</span><span class="p">,</span> <span class="n">upper_raster_files</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;lower_raster_files&#39;</span><span class="p">,</span> <span class="n">lower_raster_files</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_check</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid Type: </span><span class="si">{}</span><span class="s1"> should be a list&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg_check</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_check</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid Type: </span><span class="si">{}</span><span class="s1"> is a empty list&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg_check</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">arg_check</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;upper_percentage&#39;</span><span class="p">,</span> <span class="n">upper_percentage</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;upper_probability&#39;</span><span class="p">,</span> <span class="n">upper_probability</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;lower_percentage&#39;</span><span class="p">,</span> <span class="n">lower_percentage</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;lower_probability&#39;</span><span class="p">,</span> <span class="n">lower_probability</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_check</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> must an integer&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg_check</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">arg_check</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;upper_percentage&#39;</span><span class="p">,</span> <span class="n">upper_percentage</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">&#39;lower_percentage&#39;</span><span class="p">,</span> <span class="n">lower_percentage</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_check</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> must an integer between -50 to 50.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg_check</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">output_tif</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">output_tif</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please specify an output filename&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_tif</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Output directory </span><span class="si">{}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_tif</span><span class="p">)))</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">out_prefix</span><span class="p">,</span> <span class="n">out_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">output_tif</span><span class="p">))</span>

    <span class="c1"># Process upper ------------------------------------------------------------------------------</span>
    <span class="n">temp_file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">out_prefix</span> <span class="o">+</span> <span class="s1">&#39;_1_upperyears&#39;</span> <span class="o">+</span> <span class="n">out_ext</span><span class="p">)]</span>
    <span class="n">upper_tif</span> <span class="o">=</span> <span class="n">persistor_all_years</span><span class="p">(</span><span class="n">upper_raster_files</span><span class="p">,</span>
                                    <span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">greater_than</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">target_percentage</span><span class="o">=</span><span class="n">upper_percentage</span><span class="p">)</span>

    <span class="n">upper_cutoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper_probability</span> <span class="o">/</span> <span class="mf">100.00</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">upper_raster_files</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">upper_tif</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Greater than test returns boolean which can be converted to 0,1</span>
        <span class="n">data_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">band</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">band</span> <span class="o">&gt;=</span> <span class="n">upper_cutoff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="o">-</span><span class="mi">9999</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="n">temp_file_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">out_prefix</span> <span class="o">+</span> <span class="s1">&#39;_2gt_upperprob&#39;</span> <span class="o">+</span> <span class="n">out_ext</span><span class="p">)]</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data_u</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">band</span>

    <span class="c1"># Process lower ------------------------------------------------------------------------------</span>
    <span class="n">temp_file_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">out_prefix</span> <span class="o">+</span> <span class="s1">&#39;_1_loweryears&#39;</span> <span class="o">+</span> <span class="n">out_ext</span><span class="p">)]</span>
    <span class="n">lower_tif</span> <span class="o">=</span> <span class="n">persistor_all_years</span><span class="p">(</span><span class="n">lower_raster_files</span><span class="p">,</span>
                                    <span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">greater_than</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">target_percentage</span><span class="o">=</span><span class="n">lower_percentage</span><span class="p">)</span>

    <span class="n">lower_cutoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_probability</span> <span class="o">/</span> <span class="mf">100.00</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lower_raster_files</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">lower_tif</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># (band &gt;= lower_cutoff) returns booleans (0,1) we need (0,-1) so</span>
        <span class="c1"># convert to integer and use np.negative to switch it while maintaining the nodata values.</span>
        <span class="n">data_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">band</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">((</span><span class="n">band</span> <span class="o">&gt;=</span> <span class="n">lower_cutoff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)),</span> <span class="o">-</span><span class="mi">9999</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
            <span class="n">temp_file_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMPDIR</span><span class="p">,</span> <span class="n">out_prefix</span> <span class="o">+</span> <span class="s1">&#39;_2gtn_lowerprob&#39;</span> <span class="o">+</span> <span class="n">out_ext</span><span class="p">)]</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data_l</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_tif</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">band</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">data_l</span> <span class="o">+</span> <span class="n">data_u</span><span class="p">,</span> <span class="o">-</span><span class="mi">9999</span><span class="p">)</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">))</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;30}</span><span class="s1"> </span><span class="si">{:&gt;15}</span><span class="s1"> </span><span class="si">{dur}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Persistor Target Probability Completed&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                             <span class="n">dur</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span>

    <span class="c1"># clean up of intermediate files</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_file_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get_debug_mode</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">ea</span> <span class="ow">in</span> <span class="n">temp_file_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">ea</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, CSIRO
      <span class="lastupdated">
        Last updated on Sep 24, 2019.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>